language: node_js

# defaults
node_js: '9'
script: npm start test.node

jobs:
  include:
    - script: COVERAGE=1 npm start test.node
      after_success: npm start coveralls
    - node_js: '8'
    - node_js: '6'
    - node_js: '4'
    - script: npm start test.bundle
    - script: npm start test.browser
      before_script: mkdir -p .karma
      addons:
        artifacts:
          paths:
            - .karma/
            - ./mocha.js
        chrome: stable
    - stage: lint
      script: npm start lint
    - &smoke
      stage: smoke
      env: SMOKE=1 # just busts the cache
      install: npm install --production
      script: ./bin/mocha --opts /dev/null --reporter spec test/sanity/sanity.spec.js
    - <<: *smoke
      node_js: '8'
    - <<: *smoke
      node_js: '6'
    - <<: *smoke
      node_js: '4'

stages:
  - smoke # this ensures a "user" install works properly
  - lint # lint code and docs
  - test # all tests

notifications:
  email: false
  urls:
    # for gitter mochajs/mocha
    - secure: fUrHenYJs+pTuLtgBRoYyrlyfVekxaIGmLWq7bhUUqBj/7p5eCkQFn13LlPht0/4WWZOiPBcdTN7tKnz3Ho7ATUJhAchvOWDUgL5gtTvOzeCHbPuCvHz/VLK6hMoPdbLA45M864NDLotfHvyh62WgQaVw9iPc80eb+umaDPrYiU=
    # for gitter mochajs/contributors
    - secure: rGMGYWBaZgEa9i997jJHKzjI8WxECqLi6BqsMhvstDq9EeTeXkZFVfz4r6G3Xugsk3tFwb/pDpiYo1OK36kA5arUJTCia51u4Wn+c7lHKcpef/vXztoyucvw6/jXdVm/FQz1jztYYbqdyAOWC2BV8gYvg5F8TpK05UGCe5R0bRA=
  on_success: change
  on_failure: always

cache:
  directories:
    - ~/.npm
    - node_modules
