<!DOCTYPE html><html><head><title>Coverage</title><script>

headings = [];

onload = function(){
  headings = document.querySelectorAll('h2');
};

onscroll = function(e){
  var heading = find(window.scrollY);
  if (!heading) return;
  var links = document.querySelectorAll('#menu a')
    , link;

  for (var i = 0, len = links.length; i < len; ++i) {
    link = links[i];
    link.className = link.getAttribute('href') == '#' + heading.id
      ? 'active'
      : '';
  }
};

function find(y) {
  var i = headings.length
    , heading;

  while (i--) {
    heading = headings[i];
    if (y > heading.offsetTop) {
      return heading;
    }
  }
}
</script><style>

body {
  font: 14px/1.6 "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: 0;
  color: #2C2C2C;
  border-top: 2px solid #ddd;
}

#coverage {
  padding: 60px;
}

h1 a {
  color: inherit;
  font-weight: inherit;
}

h1 a:hover {
  text-decoration: none;
}

.onload h1 {
  opacity: 1;
}

h2 {
  width: 80%;
  margin-top: 80px;
  margin-bottom: 0;
  font-weight: 100;
  letter-spacing: 1px;
  border-bottom: 1px solid #eee;
}

a {
  color: #8A6343;
  font-weight: bold;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

ul {
  margin-top: 20px;
  padding: 0 15px;
  width: 100%;
}

ul li {
  float: left;
  width: 40%;
  margin-top: 5px;
  margin-right: 60px;
  list-style: none;
  border-bottom: 1px solid #eee;
  padding: 5px 0;
  font-size: 12px;
}

ul::after {
  content: '.';
  height: 0;
  display: block;
  visibility: hidden;
  clear: both;
}

code {
  font: 12px monaco, monospace;
}

pre {
  margin: 30px;
  padding: 30px;
  border: 1px solid #eee;
  border-bottom-color: #ddd;
  -webkit-border-radius: 2px;
  -moz-border-radius: 2px;
  -webkit-box-shadow: inset 0 0 10px #eee;
  -moz-box-shadow: inset 0 0 10px #eee;
  overflow-x: auto;
}

img {
  margin: 30px;
  padding: 1px;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  -webkit-box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  -moz-box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  max-width: 100%;
}

footer {
  background: #eee;
  width: 100%;
  padding: 50px 0;
  text-align: right;
  border-top: 1px solid #ddd;
}

footer span {
  display: block;
  margin-right: 30px;
  color: #888;
  font-size: 12px;
}

#menu {
  position: fixed;
  font-size: 12px;
  top: 0;
  right: 0;
  margin: 0;
  height: 100%;
  padding: 15px 0;
  text-align: right;
  border-left: 1px solid #eee;
  -moz-box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  -webkit-box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  -webkit-font-smoothing: antialiased;
  background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGYAAABmCAMAAAAOARRQAAABelBMVEUjJSU6OzshIyM5OjoqKy02NjgsLS01NTYjJCUzNTUgISMlJSc0NTUvMDA6PDwlJyg1NjYoKis2NjYrLS02ODkpKyw0NDYrLC04ODovLzA4Ojo0NDUtLy86OjwjIyU4OTosLS82ODgtLS8hIyQvMTEnKCooKSsrKy0qLCwkJSUnKCkrLCwpKiwwMjIxMzMqLC0tLS0pKissLC00NTYwMDIwMTQpKysoKSovMDEtLzA2OTkxMzUrKywvLy8qKyszNTY5OzsqKiw6OjswMDExNDUoKiozNDUvMDIyNDY1Njg2Njk5OTozMzU0NjY4ODkiIyUiIyQ4OTkuMDEmKCowMjQwMTErLS4qKywwMTMhIiMpKiopKy0tLjAkJScxNDQvLzExNDYyNDQmKCk5OTslJig5OjskJSYxMzQrLS8gISIwMTIoKCk1NTUlJSUnJygwMDA4ODgiIiMhISI8PDw6Ojo5OTkpKSojIyQ7OzsyMjIpKSssLCw6Ozw1NjlrfLakAAAg2UlEQVR42jR6i3ea6rYvPgANIAhVXh8WvkQlioUiFlFcBtAmoiRNdzxqu9p0J7vrdK29zuPeex77nnvO/35n1r1ndHRktI0jTOacv/l7lCBK5UqVpOha/YxmWK7BC4TQFKVXrbYsnimqxuuMVlOQ0XltWjUdCwRJ1M+tC1KudOs9q6+da2adUewG0SC0SwELfHtgDds93VEuydEbl3QMWeNoYkR7b/0x1ZRobGI3mLwzAhePqTAwhg6aogjNsGy7/jwQ4rkdqe7CWLxF8k9LfMVFyRS7VJqtkrW8Vt/bkR8FZJao16ipknbC3Yw2lM7laO6HBEOadEZ2tpf65c4v8e3u7FyU6qbiNNyCuzXZ6pawgnwgmrpTT/Q7w2EZmiIJ0dzWDI7mhQ80IfRnMu2kzA5r5r1pIFoia+/d93HRYp1GV8TbrkWoU/+jdI0Ff6yGwTjT1Hn8J+8m1rKpGiYPuNiHnMtNMIv+zpsk84MYTNW1/+DpwXLvckdOCMYowVNPREe0QlM8xRHXXFhcNDzupwsSmb5pH+0t0RP2Qk+QtI7F1Qm6JRC6ZPBtPq/dq/kH+jxtCljn9TIpW6rQIgmSVyj6lPICIw4N/taka41PFUInth0je9+jO6Kt1G4/a7V2LEgG02B0pHVuCZrgltSKMuIl5SyufUv9mYuQi+mFgzbBEtFo2g+Dh4sSTrLNu8JPh00sQydpb00tqXBvqRN7Q7kqzcnIxCGnvZt/WmJacoOEO6Dcn8Qre03pOCSQxbMOXUuDNx9SxuLz4W1I18gvjViQ67zV0rxdWL8Te/TQkuo8STS41DR48W7L6YP2uWIqiUV8rd6Gbf/rnegKZeG8TpAM6afhGze9JAOxbLjsnUXEbrZ9vLYd7MT32cPF5mKKxmjy7huaoD9n62GOxni3iIJwv0IzZAZjdZkUtolCNLVfYZNaquFjGszVVf+J0vrz4CawoKdHnOzb0NMH7CDBOybfYNJ4rfeMyFNjkFYVTzMFs87rnPGXLUOeNKRVc0LnU7/UIgelzsy3CMuth0YfvnY0wsD3vODUL3eJcKqHQpm8yM3XZQWJxO6Un9iYloyyLpOwN2obHy6W6gbpcb44XmyC+mg+itAcaprGcrwZCqMj/GmtKn0zPvpTz/Cv1dw21XwP3cRupg3H3MF/S71eTKj1YrdwKdc2Mw0fRmb2sFf8lW3aU6JbIZSEPqvXvjM7G/aApyXlXeqKfMq0g/Su3rUGJPSPrtGElgknrZM3xUXqsAP6zMCNVn5u8aJnSNpJv2uru7t2jfRziW2+GuhqfldUNbPk71olwo+46ePUo1U3WKk/e5YK07F/wGRgcpODmQnIlVeHCWBE4puBi2jq28UKpqiN1/4UOrGz59TNYrrQHtd+11sG40BGD+pXdelNqGOg4NXe8W4eacJV/NS9/2Umtym6WQqveqR9xdCMElpxnbkalM4Vf9uaEcWZaKdyibEIjWKxJZPN95niCL3GiaXyssIrHxoLkqkzLCXULN46/f2h3tQJgyip+Tk9EAjJ9aJshq7t8X45aowSKspMSvPf7r9R8yxNptIaHS5ozuEm6luPDApugyNP8OaqiQ4BjaequXA54SLC83eHIY2r+CZp4409Xqw8Aa2oI7XkCrQi+in0w5AqF/kLNrcUz+qkl/lAobY1jSnx5OJNhyXIz3qfNFlXc0TKaglNwdWkWYt9QQ1Kr6W8zue21iNrdJk+N5oCr2O9nEtWKC7IS5J/zdDEYrmnAYfg6agCy+qcgz7ZofeDc4PbUWSvkshWuAc7OjiUyLkj+RAtdlwXJcjxdpkTTHDhK8lBCi8+JtvDVL1W6elmOM++YS0LuSlaP1oUvAeiW3cFnvTr8EbTz1tsSMYdGeZe40sRWu5uAfj7q+ZoKv2FNQ0p5XY1lmlcigHZqTPpabufEVrNuNPi165w3uCVQJHyJqmSJ7ZHnguqwtCmwViIJijj04ba2JNYtB+yORf5gg1/9t9iw4vUpeqiunSAbf+IBdj/b+iG2qrHvuNP0Vd/+ThVZT/lrvHYjjgDbbyxaqgHNM2uhxa1GW3UedZYhMMwM4mQhltouK+IV4NdbIQNM+8Yv311RZk9kT4tiYR4LkyFcuPpdcjuhUuFqBAWRZa11lcZ3gEBlXywsNhrt+plISZP5DlsV9l4EgY6J3yZPTUcMrgaWAT3oI79eSbGEbcJpr6BD8kyDiVt+G0/hXosQN4NFXKlfWIfsIs0BHODVok1/IGnKFHJYIquh8Xo+2+bkQNTGgWmN/fZ0Y33LSj6lr1GyV7mWIKg7ZTRZPGuhF/zjRNcQ1UPtSYgnWQxSs0yrVhwNDcdGMNSNe2JT3WuzbAM3HykyAajS3Uphf6STKEqxLas9EnmnhA/lyj9Uj+JoY7SVgVmGLl46Rm2u98sbkap2lzAdKBG4r6LgulQOSSjQv1GWdQ0jtDUK/mAaqM1Uqjpu4k3Rvfvxv7YTxLSK+wN3E5jVIzmF23uZ7hiH/sVP49D7tvoKp4S8b1LuvRlivVB/algbhcFITYVXvDpLzpDfplR2uD5V4XJFxpjmIpLc9Y5sB2TpBRix7Bme6GZIq+06v3XzNeTcA4obQIKxrnT4C2JpOqD92dbmSX8MGazly5EsZVMvSU1f4RZwyu8iQXbVdeLlZrjuTT1jrY1uk5c7iZ7RsvhhluqAkq4JpVQAg7RJFtSu+xgJ8Pv6O1j5DkLxT8mkbfyRW5DrQmG7hiDIjCgBsADbjuof6YHLGeV6a5Q1Smx9joUXPpdaaDx97A/Wq00oJkdR7ZYuQRfS533JtxO1erduqWOYIt3wh0wpbLuCNIYkwxbswbikCUu2CDCS+Q+7rgVtfRcm+SOcdKPRlZ/rE7wNVUEE39KTS5uvUKN1PUnkloPkyzhyGQ8qkouEjJ3H/VXdqG6asSRiw3ecMlBvDDt8dDhBHXMwZ2Cajzjr7/76T+IavqPYvz6r7//E/3X3+N//h/0QozbjPgPiir69P/8X3/9F/yv8b/827/++98WItPu5/Hvwd8YPf5bp/2/lX/T/+Of/0MJ/lYTa+L/Ef+d9vN/3/2T6P/+jyTzu/evf6U7vxN7B6pJkRtAF6jUr8I+P8RsP/ptGhfqFk+pQ/DgAy6NJtRYJdXmp4gK7WLqLKJ+MaKhGjOojvL+SnIWrkpy0SLHDe4QuyNzaEA15mLMCcmE8Em+4HdOihW4/ZWuppJEmzeAwcDtv7MuLc9y2V5atvxXNe3S4DUMt5/Qy2LM9kSYKiVWBuKlfp4nxTntpuW03JbIlkiRvBXmT23g1I2OYe6IizUHPIq6zm6mbfsbteKmi/sg9J+ocQBMctGFO7iljo8TPN+z3jxw4do+ZwfqoR9dkNTKHyM305GpTkfhcHexVkPVGEbUOjuo9f0UMPHBFlGEx0SLvJvVRKTwW7PSew5oPme+E42+frJa9cGt2njS3dK5kIif2eYbhuSEQXEqMVfUjhGIuin0G0/W5ezJyJQy3SpMLai4M0JUWb5u1k9tny5bd1pPwYBpQuDCXZl62xg4CdVEAtflXHs6JKmP/pH6mOl796Lgopj0o8d5kKh00hxG3OSdEE/QBo9Hgr8JJqAeLDwJohG5j/DGh61Rc/+tf22/8kEnxHNCEjo0ElvvGfESZkqmz2BDcKV1H1buSkhkdg7p1IMGs2s17nYjpblrWuE2K9WEO/hcRp5e9oOF/QBmOaDtgil+oaU6szPrdwW65fOB0KUTsVUn7LFU7J8e6cxJIl9+FHw5MQMzuQJ+4oxMH3iW/5GK+hWuG0T+gTLs+fAjdtUd58TmIUq04EeyRCYCjkldow234aIgR5bqwrtZosZ+6YEqAmDqatJ9lWasz4IquKALPtd92hGI3Z2BdzzZue+REl1Om4DIWD+RrtUTOJLI+S0jHowXXdAxsGLSd40zYNuEUlOGhrwL6c7tcOtUOvpJCP7QBQS19H+GvZn05ewjlVLz+IGKoC9TyfQjLMBNmXCuqqtTdOSukZW48B0HqgSTCBrBnlFvF4CG2Su7yFzqmJFURK3UmTT3ru050r0ptUpMilYnBJWfl2Bv6kPlUuE1kxxpdzui9AubsR2N2boVSu81OulAwBqoSr1LZ0LLYOomyZHmjqnXlP72s8LnDouEJjtodBvdHaG1jMySYO7crWd90MpCRyCG14vb5IE7Arupw/y/RcCm/Tm3zK6zYj8PYNaGldiUfkB/LHWcmf2lVM+mwyU27a0qq2tscrQ/vzBjN26DnntIrOyGizzXK35yKQdYnUABkyN4saz3WD/viF+eCcsXnIajdWYJWaYHRstIis9CS+tqnFGmz2j5uzfr3Z4prqgK4XOT/PyftvjZqIm8lhkfxJ7Ol3CJF1piYBGAG8wtAk56Drw1YwmOpcz+NdfkSpSLplRXLXHL0Rquj6YW/gabqgK7Dgr6NwtH0B/AN7XrN+MVJ6AmXmUuqmQulrNNYPmH0RoDogydOKLo/QbfYNARSQQKISRCzRXU+q9WWJFL3LZW6u34CkeG97xC0NNGaJ0bvK6SnZS3zPskr5EtuCgjMWR5o2x5BqhKmDWJPRe7JMEOyRb5uUKlHaGVtq5ivSOaSliSXp9SQm2qk8MRJh10MAp9QQ2H5t59J8rjiwSZtoIfMGjlLPVNdYl/LBR0AO6WLGDmkLkIPRE45Y9MftdAK/yNu1Hn6tzOQTesgQ+8fSzB19wO91vCnO23vOWQdwJ63SJrYjdfKFW6W281PKs2k8iT9ai1cgJ4sa3xqdvmtxR8/+D1B8AKc2u+6JftryRhMWSQtoSBgIyyQGyxcnELuAasXN12oSriU4RMz1DD6RL0TSV+om7i1Yt+jEE/jnawM8cX/UhN4nkiv/w9eALrzNhXuQfOzFL0Fi6SjF7/4Qn8rLYBoa85cvgAnkCEBP+HPbEnquVXCZsMS/yzYw2Vru60P/+nJPYKkzZFjmbykzUoEqV836T5q3fP/L383dF82tx18/AZgZczMAgyeWYKmSZIqtHL+e+O4ZRcq9VI3g/qPeCoiK4pcgEqdbS0S/Be54sbVQOuJVPNBblIghzeasNu7h/g+Sz1IdhI5lCwq1nUb3Ji4OCIcqQZqtqJ5w7rXrg/DA9IgVmEGhDgGecEwnCTHffXcXs0V3OCEVzYDKS1vp/oX+ng+6XVU86UjA6FMO2RXOOOrqY1GgPvrAk9HV/BXtCu5RuwF8qgdGDLsBcui4E33ymdBip1X8uKyhIWT8qNRDsXz+gvO9UiEC0d8RG4Tf2x8H4slljgHtCBcxHLTWOYJm5H/fCPCzOgf9qgOUxTRZ0Pc6ha5yLuLVT9ntvIa6gacE99mCovdUumTQdRP4RPsS9129eEe2uSvvGh0bV4Y3QPPhPZMqhZWSMa5R0Hc1SGO4IVOQc0FrirlibTVfKRrYkD8kz3b+X65/QkUNaZdrdl3mCap0Hf3YcCw/LiouJYNbqz88UqeDYv93yO7vvXtgl4XCyAO4ODkY6W+83+LZU//p3/zXNGGrUKClCiOnL27iJZbNWDF02XXAOeFlB7IaADoMH1Yqr+UP9biyZDEa/iJt4MDeIz6GKTdLVBfWGVtRN4fdT2rgReX8UXwF2zOrradm4J0nyTgdPnai3RvzpZvCKDUqjOwD/QA6EDaMCLewX6QWYVnHY1sx1bd8ovYnPm1ZvPH+rE20lWjOCnZ66/xDt0QAl15FjfBcZp+i9OU0RNPQ0t3x2pSNWo8eiYudwsnuP1Hq6iH1LJCJynkYsfgJ0p3pF6SoQk2l+jqE8CPk+ziGJRSKjs+W5AO185umPdkYzlK4wl7TC9NxyyDP7ZoyYVoXiuS6SjnInlLWrwz1i8bGTKXX0AVQWkSfIlglW3zRJRJ8bg5VgE6ZEnqNu9B++0GNQvDQJvFize4ESNKBJP+8vA3LM4AX5SIBq08Mob+7QMTCZx4nwP/64+4BnlZC+8WtlP/CXw6t1PwMwkJ3jhP1FiXLhDF/3I6FGUzO2DSi9ABxKyyL9paZxSEz40ZCPQToDAJu1959k7QdbVxgB4icsu2s4zsTPJhcEDo+N1GX4zSk/wriRh8AqwL62972i9HJHd1ydaLXVzvKvOfGGw5RVcUVMiKXFH4APdkQU/dc5BX0YfKTNZYXCW9mb8bc8mufoQP6BbdQmT99ZjoYfr/go4TgQX9IDgztim7wyFeGMfbNaeqj8Dzs38pgcqwSv2hbqB3oSGKWKy+sesY7p57wAHldqE6NDudk/W7s/zjrK4rZFlFvaGxnSZdHbc1y47qDN6xkoK8O3bfr2j41dlJZ71rB4dlDqapPFa8N6xBrprUdtenUCHwxKNhw1uuTBh+9uU45k4REpQABN2bAO9DSLqoIL26gNroWgup5pUMxHUNSq4Gyz47vBPvilpo5f9OYI2ddAqTqmnxXERxQJ3UK8fHbVE9HagHi3+tqNRoNsArdmAxHA5LwtQo9ZAaNKUTljnokljo2x8scqVpEEIPc01fPCdHOCg0DeWBz8D5TVAAfx8aRH5X2ZYNI3ebKDZdeJ+oBDAxmRqJ30Eh2/DaeAy5diVNMpEDmXiPDsGTzBLXy8eVDdJoIafgx/gxMyQi454QrW56nCyeELgSuNNEmYkflF+t3CZQOVRWjKhIuCclmQSlAXT3+4JGG75B4t/5hQ+ldMP4LsAW6z3XmU6IJJwpnGVnsgUZhoY1fZlwTR8wSU7xRejf2uCx9Z5trVTRRJP9KnEb134dEieil6eCOGWgboI7xsqsqM99jfJLTePjygKlH2CVxxsse9QRzTBFjD/Kjqitr/CCTBt/SJ6nLxz7cKP9pFqBpp0lN5y+adKNsZjrPuroemZauH9aTTFD3EKHW8S55XBLFQAt1jgxTQCTwxmx/JyfsZDN1RroN3VaxpSenpIX7K+ZbL8VdlQDcI4Cbzg3QJLa9yVqNxUelu+EtxLVqeekaAvSJkO6sSVqbUajxqhKshNpvZqoeApF0k/0P0ikkwUcbdwc4A1ejN7Oo0O15kG7hTMoK3hZRBCX7YYeLW0wvcXx/18n/u37yLgzBYVBUvORGli+sfRcX/74uD6P4hq+7xu54TlWJLFzT63uwUDwuEDdOjJQqx7JV+ZjaEAPi7t0MMrR4Q8Rkf18uxD6RK0RKh0hL8YU+DeL97i4pa5ZSyAfXKwZRS/8gXcxdZXm62RBDj8U3sN8x95b5PpPs/mCBKYvpaA50pN5Ct/499AFTtwQ5vgeSh+NHrKIi4NVpwM/XzRaNfJD856lPE6M21zWPguFsH7jbLVyEDfRmt4VwrhCJ5VTYmcSPfGgO5clfN+vbaDZ7sakU5+2vZ2WCDY031NxJarVytfDDVtiafcTGO2rJ/taoL3zChN2qmjxofczTOYQPPVQPh0JVtYgdUQINcSiNEEy58UdYXX1MpWUCEBx7LbcGtAm8XWRQTVOaoV3ySri4RShhs/B/0m4jX6OAwXOvcA09bNSG4czEGv/Wey6V/jbTCNTW6awXdNTcA1GsPe1E9fZdGl7R0vyoVpIdJtfC6d32NNErrvq/R+d65VG+YOwRXppXxOCYyGNSf1K3x6VxAW/vtz4EC1SgCOSPdN62sLsoIzuDfg8GwZAbquVO8HIuFP/ToVoeUB7nnwMF35a1wK1tI6fkrqFKhQdeJpwyls0pIy8AZde3/6LUUbFaYJthyUJSU/kqDXTLQElnn0Jr4B2RVghNrmNmoEn7pXIeshPguXVsvwoTdmClq49JJU3LWhHyWTrJL9bRP6VKv3tZoA/th77p5Jw++OEENvyvWy/pNeExiDUVQaXIRGh8xySZTI36yueFaSXo1uJY0RnXYgEOoWWOJHeaVuX/bGNhHsh2yinznl/++NJcE9j6fBPRcBdq9hb8awNw8U7Bl6GM7x69EDOIIbX/npZ++amlHR9L/35mE/2Ss4gb0xCcY4VyTFLRE796vHysLAamqcyO+aFQyJIDBNslbH2/MrAvZiSEIedc/cqjmv4fbda2pXbv+F5a2szSsdkm9noiNURXt8edUhGUF6fSZWd1IJaXKFwD+49R6eCXD4Bkef7j9tRtNMVgW8BhRz/Qpy1TmeYk0doyjZoJSbePOReVHgkFsCFuQJ+Lgc4BxeAsK/cOiNDRmdNw0ctYhn/nQ498dYI5znzGLoJi1rav7Cn88rL3wLePVtDK5gl77Tki3gHEsIAQ2+IKgarj7Y8W1IQzV5V9N+0TjLqbg68WfKcOmBCOj3JkwJhVIkwDhc+JorXuZEPMEh0vvH3x7iqf+VAwXgd4diZiaJD1zHL9Snx6Wfg4IugreyhabQkcir+y5XgDtdx3Avs7lkeeCBwDvZoTUCXx5QrZkcEqWfYEiEYRs/EphmRALSNGR1Iclgdr5VFoELpzF4++f35w3/j0t5ucW3n2ch4PQCLuUXupsPRR7UA5FjSKrMtPcKAZJfagO4lGE7FH3YKMjorpK0ZxAv+i2JkJhtAMWWWFej4RhPR/cJ3DxwocCvXDi4SGZU4cu+K32XndiFWgopAl+0GApcwf1XvymJcFs39jExIBO4yUjU9MExBLQYc9H+W7+IgdESPRpciT+rKZPebVtaVq+1GYO/5xTAL3HASjNTGIgMvdjWbgc7JvdE1zIFpuC0U9ESiZyzBixzxWxj4Kwh8My34q+FK3KNLtmsA1qyrmKSNQOXCPUZd+ONelBTvFoUI/CYsqa/RhtKiyMf2CgSFqEPk59Y3uqnlZ8gFpswfSYyko23yVZYxzKGxGm49Zqxg1l8oz5Ra9XaRwHkuxepmgyhm0SoNy2KlbcEqK+9QqS9PNx9Ihm9U7gsR55SSJ1FBDNnkuWKxIZ0SDpXuOGwZdoUbOMDPHP4vBAgz2VlSEJAHZGJVbYIg7l/FO5KfIVvxC8pPPxMGcNMoevFDeStt2iqztE10n2TA4dgJH76YS9HDhKHD3iCx6ieFX84BAI3QQnngh76f5ruPQVbr5qZmck/5UjDc26lfrOvUBWy0Ogl8bCoOkMOns81TnC3cuUS9KW8+9A+fe3XYZOFUPG1u5epSSmDLw0s5s2F0W30ANeo+zJkJQz9SPZgzwYpEoktofhGVfmLOAB20boCbW1QWq/NpET/hnMecw/uSyAH4NJc3ECOU4nnkK1fj3S/i5dwb3R7k00AqQQUwt7Ie1qV0aY/VQX0J8hLPy7eBNXMHYZYDNxHZ2Qh6AuXJxq+AeRec/Q+JLhZV6hpXwQEzw7bf5v9uUf2vpq3qlhmy0IIGTkwYdCfSAFmqbdo+3XvDTDjFJde0mbeQLcn2n31xaAqJ0ixO/CLsT4I4G4DoncVTgRGNBtsCcjISWT+oeXZ4Iedw/8OsJI1aPnNKLX/60VvcZb94uasRxCkqlPQ11u1Sa2hHvB80WQENxVyzjns0/PiEByyil21Te6oisk3mNCEMrhouCFO3yEZTHHOCMy9eb/4Tmi8cVf3Lf7P53SY2hX3PSN033As3ETIMLHWumWEO9JXHA2y2SIBlIPpLGG2qvNsCIlIr+B1SWAqRKm2w6Blf7U+zCSBwJrfHG5i8J5Gax/cVonMlon7aHJX/gSvucIncRP93XCqkv7D8IFKFsLiBgHqUpXhE3pYjEcV1dk/JD9zFVCfEaQIVX8Jmfz7IIofcBKQ4OaG+C3xC2veX9CD+iAFXDNaGg9eTVxvkbJRJlW4Nk9Wk13kn696jWppRDe/8pDrYMO9ZyxZ98ReKSz9kWKLLyk2zCZgAniCkLJVX3n1M9DYbomyahWiv/KixRIV9hj/oFz87I+HLznbPTjpa+D+bZQnMuRsljTpv90vQUt/pK7jCFnA30B/jtroSF2/m/gpWn1aQs5WeA6ghzF8SdqWI20fghdSeDOCSCmLgTkfaGgGDmw7nHFkRzGtag57IHS2na06I+gzEphXo1w/Zx2BM/jKL2nZoFjHggtFQjYi8nSVRSXIE58RPbBObXk7uuIL9+rs/5Zo7suJInEUxgsiZZAWS25iBtpEiZeBgDtghEoAE0sjcayNq85M4tbu/LF5h51335PsGzQ09O875+vUS89lkWMyNOFoip2PuyWyMP/iU2XIZdfCCJNDjebDoBLQdpy7QQZC7s9c0wjHJervQNDu2jWzBW5MSAJMr7bP+Iv92BkS/GGgzjEn7MF1IRKFwwzbjbS4/slGOmhx9cZrFu7HSEefojNv3r0UaKfKOWzXsq1zEugbzlMDFsacRJJI/iJlK3vtkZ+PLZIVMFlKA32wbq2Kd5T0uCLZ1CPkAfCdzkz2EYscjDcZq2AWfziN2covN4kXE1lQXPPLTNM1xx3tbiepcO/t3SWm4w87qfh99SL0ZnY+LKFPLPeXVM2mIIoVWt+9Nk0I7nY4O79iGYqxZ8RVz289an6NVdJWnSKZvJQCAuHNiVaDxPAFoH392t9wot5t0/qmU95eEWNbU2udUW5sN9JVqcYlvAIfLeYC33oUzzxZgSktsv21mA7Uly1FA5VnoJFh6N244Wmv3YJGFv/TCPryaw+ZORlpZjQdq/2DYXr3EZskfed0G61P09ipTKmlTQ1067Rg5+PAk5FlQ9e0SWbGf2B/08kqymOTMVOznsALHHNFH4LFRKl2F/NOiYFl9khNHnSu9Ak5sq26Ynl/i2fdTle29Y1ugqmR5Yj4YT9pvslFyYCbw0mNFr5rVQm1LvkG27QMq9ph3t8fmn6r6SQ4oSbr5tz+J1kIawGzDxb6VYOvvWhobDTXfBeNv3b4aNm5XUinsCGqG2q/45m3+LoCOsddFceYhRx1Tsss9PLdPfJdErFMjYd3gddjiP0+XQjcRadZP6bwNLySvunFf20Czy6JqdEW2a96KxdYdOryBv1BjbuUq2yCHeh+6sk7fGmmPi50pe/1l5TyPe5oHW9oPnhPswLyf2TFDdCyYlhwBCstv5C1HwlW7xWoGT9XZt4qVj5WryLPLLD6h/5cMLEjWzgCeAIKNsLak92aBqBsHl4AJwl2N4jfvbSkBExGimv0nFvv09uDScQbjx+w4kPQjgjlW+g9ws9VEJvI2k8N6XxVu0uIwovgTFdunG24gBtaDi+y1YLQwZ8mwbip5fVlO3k0n0AEr/ETbtu8Vjkm+nNSiEb7X/3fMjBL5A8PdgG+/FnbexbFFExmEfetXAnisEKy5z44WVPpQZjSy/jzeGn4yDRsFGqhh87QPaDBWhlo37IFbe/C0xynS91d2tP/AJoJS0sVF6iwAAAAAElFTkSuQmCC");
}

#logo {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: rgba(255,255,255,.1);
  font-size: 11px;
  display: block;
  width: 20px;
  height: 20px;
  line-height: 20px;
  text-align: center;
  -webkit-border-radius: 20px;
  -moz-border-radius: 20px;
  -webkit-box-shadow: 0 0 3px rgba(0,0,0,.2);
  -moz-box-shadow: 0 0 3px rgba(0,0,0,.2);
  color: inherit;
}

#menu li a {
  display: block;
  color: white;
  padding: 0 35px 0 25px;
  -webkit-transition: background 300ms;
  -moz-transition: background 300ms;
}

#menu li {
  position: relative;
  list-style: none;
}

#menu a:hover,
#menu a.active {
  text-decoration: none;
  background: rgba(255,255,255,.1);
}

#menu li:hover .cov {
  opacity: 1;
}

#menu li .dirname {
  opacity: .60;
  padding-right: 2px;
}

#menu li .basename {
  opacity: 1;
}

#menu .cov {
  background: rgba(0,0,0,.4);
  position: absolute;
  top: 0;
  right: 8px;
  font-size: 9px;
  opacity: .6;
  text-align: left;
  width: 17px;
  -webkit-border-radius: 10px;
  -moz-border-radius: 10px;
  padding: 2px 3px;
  text-align: center;
}

#stats:nth-child(2n) {
  display: inline-block;
  margin-top: 15px;
  border: 1px solid #eee;
  padding: 10px;
  -webkit-box-shadow: inset 0 0 2px #eee;
  -moz-box-shadow: inset 0 0 2px #eee;
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
}

#stats div {
  float: left;
  padding: 0 5px;
}

#stats::after {
  display: block;
  content: '';
  clear: both;
}

#stats .sloc::after {
  content: ' SLOC';
  color: #b6b6b6;
}

#stats .percentage::after {
  content: ' coverage';
  color: #b6b6b6;
}

#stats .hits,
#stats .misses {
  display: none;
}

.high {
  color: #00d4b4;
}
.medium {
  color: #e87d0d;
}
.low {
  color: #d4081a;
}
.terrible {
  color: #d4081a;
  font-weight: bold;
}

table {
  width: 80%;
  margin-top: 10px;
  border-collapse: collapse;
  border: 1px solid #cbcbcb;
  color: #363636;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
}

table thead {
  display: none;
}

table td.line,
table td.hits {
  width: 20px;
  background: #eaeaea;
  text-align: center;
  font-size: 11px;
  padding: 0 10px;
  color: #949494;
}

table td.hits {
  width: 10px;
  padding: 2px 5px;
  color: rgba(0,0,0,.2);
  background: #f0f0f0;
}

tr.miss td.line,
tr.miss td.hits {
  background: #e6c3c7;
}

tr.miss td {
  background: #f8d5d8;
}

td.source {
  padding-left: 15px;
  line-height: 15px;
  white-space: pre;
  font: 12px monaco, monospace;
}

code .comment { color: #ddd }
code .init { color: #2F6FAD }
code .string { color: #5890AD }
code .keyword { color: #8A6343 }
code .number { color: #2F6FAD }
</style></head><body><div id="coverage"><h1 id="overview">Coverage</h1><div id="menu"><li><a href="#overview">overview</a></li><li><span class="cov high">100</span><a href="#connect.js"><span class="basename">connect.js</span></a></li><li><span class="cov high">98</span><a href="#proto.js"><span class="basename">proto.js</span></a></li><li><span class="cov high">86</span><a href="#utils.js"><span class="basename">utils.js</span></a></li><li><span class="cov high">90</span><a href="#patch.js"><span class="basename">patch.js</span></a></li><li><span class="cov high">100</span><a href="#middleware/basicAuth.js"><span class="dirname">middleware/</span><span class="basename">basicAuth.js</span></a></li><li><span class="cov high">100</span><a href="#middleware/bodyParser.js"><span class="dirname">middleware/</span><span class="basename">bodyParser.js</span></a></li><li><span class="cov high">94</span><a href="#middleware/multipart.js"><span class="dirname">middleware/</span><span class="basename">multipart.js</span></a></li><li><span class="cov high">94</span><a href="#middleware/urlencoded.js"><span class="dirname">middleware/</span><span class="basename">urlencoded.js</span></a></li><li><span class="cov high">100</span><a href="#middleware/json.js"><span class="dirname">middleware/</span><span class="basename">json.js</span></a></li><li><span class="cov high">100</span><a href="#middleware/compress.js"><span class="dirname">middleware/</span><span class="basename">compress.js</span></a></li><li><span class="cov high">90</span><a href="#middleware/static.js"><span class="dirname">middleware/</span><span class="basename">static.js</span></a></li><li><span class="cov high">88</span><a href="#middleware/limit.js"><span class="dirname">middleware/</span><span class="basename">limit.js</span></a></li><li><span class="cov high">100</span><a href="#middleware/query.js"><span class="dirname">middleware/</span><span class="basename">query.js</span></a></li><li><span class="cov high">100</span><a href="#middleware/responseTime.js"><span class="dirname">middleware/</span><span class="basename">responseTime.js</span></a></li><li><span class="cov high">94</span><a href="#middleware/cookieParser.js"><span class="dirname">middleware/</span><span class="basename">cookieParser.js</span></a></li><li><span class="cov high">86</span><a href="#middleware/session.js"><span class="dirname">middleware/</span><span class="basename">session.js</span></a></li><li><span class="cov high">75</span><a href="#middleware/session/session.js"><span class="dirname">middleware/session/</span><span class="basename">session.js</span></a></li><li><span class="cov high">100</span><a href="#middleware/session/cookie.js"><span class="dirname">middleware/session/</span><span class="basename">cookie.js</span></a></li><li><span class="cov medium">74</span><a href="#middleware/session/memory.js"><span class="dirname">middleware/session/</span><span class="basename">memory.js</span></a></li><li><span class="cov medium">70</span><a href="#middleware/session/store.js"><span class="dirname">middleware/session/</span><span class="basename">store.js</span></a></li><li><span class="cov high">85</span><a href="#middleware/staticCache.js"><span class="dirname">middleware/</span><span class="basename">staticCache.js</span></a></li><li><span class="cov high">83</span><a href="#cache.js"><span class="basename">cache.js</span></a></li><li><span class="cov high">100</span><a href="#middleware/cookieSession.js"><span class="dirname">middleware/</span><span class="basename">cookieSession.js</span></a></li><a id="logo" href="http://visionmedia.github.io/mocha/">m</a></div><div id="stats" class="high"><div class="percentage">89%</div><div class="sloc">772</div><div class="hits">694</div><div class="misses">78</div></div><div id="files"><div class="file"><h2 id="connect.js">connect.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">22</div><div class="hits">22</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Connect</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright(c) 2010 Sencha Inc.</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 TJ Holowaychuk</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * MIT Licensed</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">var EventEmitter = require('events').EventEmitter</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  , proto = require('./proto')</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">  , utils = require('./utils')</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">  , path = require('path')</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">  , basename = path.basename</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">  , fs = require('fs');</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">// node patches</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">22</td><td class="hits">1</td><td class="source">require('./patch');</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">// expose createServer() as the module</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">26</td><td class="hits">1</td><td class="source">exports = module.exports = createServer;</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> * Framework version.</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">32</td><td class="hits">1</td><td class="source">exports.version = '2.0.0alpha1';</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> * Expose the prototype.</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">38</td><td class="hits">1</td><td class="source">exports.proto = proto;</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> * Auto-load middleware getters.</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">44</td><td class="hits">1</td><td class="source">exports.middleware = {};</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> * Expose utilities.</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">50</td><td class="hits">1</td><td class="source">exports.utils = utils;</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> * Create a new connect server.</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> * @return {Function}</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">59</td><td class="hits">1</td><td class="source">function createServer() {</td></tr><tr class="hit"><td class="line">60</td><td class="hits">199</td><td class="source">  function app(req, res){ app.handle(req, res); }</td></tr><tr class="hit"><td class="line">61</td><td class="hits">71</td><td class="source">  utils.merge(app, proto);</td></tr><tr class="hit"><td class="line">62</td><td class="hits">71</td><td class="source">  utils.merge(app, EventEmitter.prototype);</td></tr><tr class="hit"><td class="line">63</td><td class="hits">71</td><td class="source">  app.route = '/';</td></tr><tr class="hit"><td class="line">64</td><td class="hits">71</td><td class="source">  app.stack = [];</td></tr><tr class="hit"><td class="line">65</td><td class="hits">71</td><td class="source">  return app;</td></tr><tr class="hit"><td class="line">66</td><td class="hits">1</td><td class="source">};</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> * Auto-load bundled middleware with getters.</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">72</td><td class="hits">1</td><td class="source">fs.readdirSync(__dirname + '/middleware').forEach(function(filename){</td></tr><tr class="hit"><td class="line">73</td><td class="hits">23</td><td class="source">  if (!/\.js$/.test(filename)) return;</td></tr><tr class="hit"><td class="line">74</td><td class="hits">21</td><td class="source">  var name = basename(filename, '.js');</td></tr><tr class="hit"><td class="line">75</td><td class="hits">21</td><td class="source">  function load(){</td></tr><tr class="hit"><td class="line">76</td><td class="hits">99</td><td class="source">    return require('./middleware/' + name);</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"><td class="line">78</td><td class="hits">21</td><td class="source">  exports.middleware.__defineGetter__(name, load);</td></tr><tr class="hit"><td class="line">79</td><td class="hits">21</td><td class="source">  exports.__defineGetter__(name, load);</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">});</td></tr></tbody></table></div><div class="file"><h2 id="proto.js">proto.js</h2><div id="stats" class="high"><div class="percentage">98%</div><div class="sloc">62</div><div class="hits">61</div><div class="misses">1</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Connect - HTTPServer</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright(c) 2010 Sencha Inc.</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 TJ Holowaychuk</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * MIT Licensed</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">var http = require('http')</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  , parse = require('url').parse</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">  , utils = require('./utils');</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">// prototype</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">var app = module.exports = {};</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">// environment</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">23</td><td class="hits">1</td><td class="source">var env = process.env.NODE_ENV || 'development';</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> * Utilize the given middleware `handle` to the given `route`,</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> * defaulting to _/_. This &quot;route&quot; is the mount-point for the</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> * middleware, when given a value other than _/_ the middleware</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> * is only effective when that segment is present in the request's</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> * pathname.</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> * For example if we were to mount a function at _/admin_, it would</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> * be invoked on _/admin_, and _/admin/settings_, however it would</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> * not be invoked for _/_, or _/posts_.</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> * Examples:</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> *      var app = connect();</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> *      app.use(connect.favicon());</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> *      app.use(connect.logger());</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> *      app.use(connect.static(__dirname + '/public'));</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> * If we wanted to prefix static files with _/public_, we could</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> * &quot;mount&quot; the `static()` middleware:</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> *      app.use('/public', connect.static(__dirname + '/public'));</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> * This api is chainable, so the following is valid:</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source"> *      connect</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> *        .use(connect.favicon())</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> *        .use(connect.logger())</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> *        .use(connect.static(__dirname + '/public'))</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> *        .listen(3000);</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> * @param {String|Function|Server} route, callback or server</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source"> * @param {Function|Server} callback or server</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> * @return {Server} for chaining</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">62</td><td class="hits">1</td><td class="source">app.use = function(route, fn){</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">  // default route to '/'</td></tr><tr class="hit"><td class="line">64</td><td class="hits">155</td><td class="source">  if ('string' != typeof route) {</td></tr><tr class="hit"><td class="line">65</td><td class="hits">150</td><td class="source">    fn = route;</td></tr><tr class="hit"><td class="line">66</td><td class="hits">150</td><td class="source">    route = '/';</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">  // wrap sub-apps</td></tr><tr class="hit"><td class="line">70</td><td class="hits">155</td><td class="source">  if ('function' == typeof fn.handle) {</td></tr><tr class="hit"><td class="line">71</td><td class="hits">4</td><td class="source">    var server = fn;</td></tr><tr class="hit"><td class="line">72</td><td class="hits">4</td><td class="source">    fn.route = route;</td></tr><tr class="hit"><td class="line">73</td><td class="hits">4</td><td class="source">    fn = function(req, res, next){</td></tr><tr class="hit"><td class="line">74</td><td class="hits">2</td><td class="source">      server.handle(req, res, next);</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">  // wrap vanilla http.Servers</td></tr><tr class="hit"><td class="line">79</td><td class="hits">155</td><td class="source">  if (fn instanceof http.Server) {</td></tr><tr class="hit"><td class="line">80</td><td class="hits">1</td><td class="source">    fn = fn.listeners('request')[0];</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">  // strip trailing slash</td></tr><tr class="hit"><td class="line">84</td><td class="hits">155</td><td class="source">  if ('/' == route[route.length - 1]) {</td></tr><tr class="hit"><td class="line">85</td><td class="hits">151</td><td class="source">    route = route.slice(0, -1);</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">  // add the middleware</td></tr><tr class="hit"><td class="line">89</td><td class="hits">155</td><td class="source">  this.stack.push({ route: route, handle: fn });</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">91</td><td class="hits">155</td><td class="source">  return this;</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source"> * Handle server requests, punting them down</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source"> * the middleware stack.</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">101</td><td class="hits">1</td><td class="source">app.handle = function(req, res, out) {</td></tr><tr class="hit"><td class="line">102</td><td class="hits">130</td><td class="source">  var stack = this.stack</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">    , fqdn = ~req.url.indexOf('://')</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">    , removed = ''</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">    , index = 0;</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">107</td><td class="hits">130</td><td class="source">  function next(err) {</td></tr><tr class="hit"><td class="line">108</td><td class="hits">268</td><td class="source">    var layer, path, status, c;</td></tr><tr class="hit"><td class="line">109</td><td class="hits">268</td><td class="source">    req.url = removed + req.url;</td></tr><tr class="hit"><td class="line">110</td><td class="hits">268</td><td class="source">    req.originalUrl = req.originalUrl || req.url;</td></tr><tr class="hit"><td class="line">111</td><td class="hits">268</td><td class="source">    removed = '';</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">    // next callback</td></tr><tr class="hit"><td class="line">114</td><td class="hits">268</td><td class="source">    layer = stack[index++];</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">    // all done</td></tr><tr class="hit"><td class="line">117</td><td class="hits">268</td><td class="source">    if (!layer || res.headerSent) {</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">      // delegate to parent</td></tr><tr class="hit"><td class="line">119</td><td class="hits">11</td><td class="source">      if (out) return out(err);</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">      // unhandled error</td></tr><tr class="hit"><td class="line">122</td><td class="hits">11</td><td class="source">      if (err) {</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">        // default to 500</td></tr><tr class="hit"><td class="line">124</td><td class="hits">16</td><td class="source">        if (res.statusCode &lt; 400) res.statusCode = 500;</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">        // respect err.status</td></tr><tr class="hit"><td class="line">127</td><td class="hits">14</td><td class="source">        if (err.status) res.statusCode = err.status;</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">        // production gets a basic error message</td></tr><tr class="hit"><td class="line">130</td><td class="hits">8</td><td class="source">        var msg = 'production' == env</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">          ? http.STATUS_CODES[res.statusCode]</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">          : err.stack || err.toString();</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">        // log to stderr in a non-test env</td></tr><tr class="hit"><td class="line">135</td><td class="hits">8</td><td class="source">        if ('test' != env) console.error(err.stack || err.toString());</td></tr><tr class="hit"><td class="line">136</td><td class="hits">8</td><td class="source">        if (res.headerSent) return req.socket.destroy();</td></tr><tr class="hit"><td class="line">137</td><td class="hits">8</td><td class="source">        res.setHeader('Content-Type', 'text/plain');</td></tr><tr class="hit"><td class="line">138</td><td class="hits">8</td><td class="source">        res.setHeader('Content-Length', Buffer.byteLength(msg));</td></tr><tr class="hit"><td class="line">139</td><td class="hits">8</td><td class="source">        if ('HEAD' == req.method) return res.end();</td></tr><tr class="hit"><td class="line">140</td><td class="hits">8</td><td class="source">        res.end(msg);</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"><td class="line">142</td><td class="hits">3</td><td class="source">        res.statusCode = 404;</td></tr><tr class="hit"><td class="line">143</td><td class="hits">3</td><td class="source">        res.setHeader('Content-Type', 'text/plain');</td></tr><tr class="hit"><td class="line">144</td><td class="hits">3</td><td class="source">        if ('HEAD' == req.method) return res.end();</td></tr><tr class="hit"><td class="line">145</td><td class="hits">3</td><td class="source">        res.end('Cannot ' + req.method + ' ' + utils.escape(req.url));</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">147</td><td class="hits">11</td><td class="source">      return;</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">150</td><td class="hits">257</td><td class="source">    try {</td></tr><tr class="hit"><td class="line">151</td><td class="hits">257</td><td class="source">      path = parse(req.url).pathname;</td></tr><tr class="hit"><td class="line">152</td><td class="hits">257</td><td class="source">      if (undefined == path) path = '/';</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">      // skip this layer if the route doesn't match.</td></tr><tr class="hit"><td class="line">155</td><td class="hits">257</td><td class="source">      if (0 != path.indexOf(layer.route)) return next(err);</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">157</td><td class="hits">257</td><td class="source">      c = path[layer.route.length];</td></tr><tr class="hit"><td class="line">158</td><td class="hits">257</td><td class="source">      if (c &amp;&amp; '/' != c &amp;&amp; '.' != c) return next(err);</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">      // Call the layer handler</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">      // Trim off the part of the url that matches the route</td></tr><tr class="hit"><td class="line">162</td><td class="hits">257</td><td class="source">      removed = layer.route;</td></tr><tr class="hit"><td class="line">163</td><td class="hits">257</td><td class="source">      req.url = req.url.substr(removed.length);</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">      // Ensure leading slash</td></tr><tr class="hit"><td class="line">166</td><td class="hits">260</td><td class="source">      if (!fqdn &amp;&amp; '/' != req.url[0]) req.url = '/' + req.url;</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">168</td><td class="hits">257</td><td class="source">      var arity = layer.handle.length;</td></tr><tr class="hit"><td class="line">169</td><td class="hits">257</td><td class="source">      if (err) {</td></tr><tr class="hit"><td class="line">170</td><td class="hits">8</td><td class="source">        if (arity === 4) {</td></tr><tr class="hit"><td class="line">171</td><td class="hits">3</td><td class="source">          layer.handle(err, req, res, next);</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"><td class="line">173</td><td class="hits">5</td><td class="source">          next(err);</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">175</td><td class="hits">249</td><td class="source">      } else if (arity &lt; 4) {</td></tr><tr class="hit"><td class="line">176</td><td class="hits">249</td><td class="source">        layer.handle(req, res, next);</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">178</td><td class="hits">0</td><td class="source">        next();</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">    } catch (e) {</td></tr><tr class="hit"><td class="line">181</td><td class="hits">1</td><td class="source">      next(e);</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"><td class="line">184</td><td class="hits">130</td><td class="source">  next();</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="utils.js">utils.js</h2><div id="stats" class="high"><div class="percentage">86%</div><div class="sloc">129</div><div class="hits">111</div><div class="misses">18</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Connect - utils</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright(c) 2010 Sencha Inc.</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 TJ Holowaychuk</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * MIT Licensed</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">var http = require('http')</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  , crypto = require('crypto')</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">  , Path = require('path')</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">  , fs = require('fs');</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> * Extract the mime type from the given request's</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> * _Content-Type_ header.</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> * @param  {IncomingMessage} req</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> * @return {String}</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">exports.mime = function(req) {</td></tr><tr class="hit"><td class="line">28</td><td class="hits">49</td><td class="source">  var str = req.headers['content-type'] || '';</td></tr><tr class="hit"><td class="line">29</td><td class="hits">49</td><td class="source">  return str.split(';')[0];</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> * Generate an `Error` from the given status `code`.</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> * @param {Number} code</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> * @return {Error}</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">40</td><td class="hits">1</td><td class="source">exports.error = function(code){</td></tr><tr class="hit"><td class="line">41</td><td class="hits">5</td><td class="source">  var err = new Error(http.STATUS_CODES[code]);</td></tr><tr class="hit"><td class="line">42</td><td class="hits">5</td><td class="source">  err.status = code;</td></tr><tr class="hit"><td class="line">43</td><td class="hits">5</td><td class="source">  return err;</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> * Flatten the given `arr`.</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> * @param {Array} arr</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source"> * @return {Array}</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">54</td><td class="hits">1</td><td class="source">exports.flatten = function(arr, ret){</td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">  var ret = ret || []</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">    , len = arr.length;</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">  for (var i = 0; i &lt; len; ++i) {</td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">    if (Array.isArray(arr[i])) {</td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">      exports.flatten(arr[i], ret);</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="source">      ret.push(arr[i]);</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">  }</td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="source">  return ret;</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> * Return md5 hash of the given string and optional encoding,</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> * defaulting to hex.</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> *     utils.md5('wahoo');</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source"> *     // =&gt; &quot;e493298061761236c96b02ea6aa8a2ad&quot;</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source"> * @param {String} str</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> * @param {String} encoding</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source"> * @return {String}</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">80</td><td class="hits">1</td><td class="source">exports.md5 = function(str, encoding){</td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="source">  return crypto</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">    .createHash('md5')</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">    .update(str)</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">    .digest(encoding || 'hex');</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source"> * Merge object b with object a.</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source"> *     var a = { foo: 'bar' }</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source"> *       , b = { bar: 'baz' };</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source"> *     </td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source"> *     utils.merge(a, b);</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source"> *     // =&gt; { foo: 'bar', bar: 'baz' }</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source"> * @param {Object} a</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source"> * @param {Object} b</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source"> * @return {Object}</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">102</td><td class="hits">1</td><td class="source">exports.merge = function(a, b){</td></tr><tr class="hit"><td class="line">103</td><td class="hits">178</td><td class="source">  if (a &amp;&amp; b) {</td></tr><tr class="hit"><td class="line">104</td><td class="hits">178</td><td class="source">    for (var key in b) {</td></tr><tr class="hit"><td class="line">105</td><td class="hits">885</td><td class="source">      a[key] = b[key];</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"><td class="line">108</td><td class="hits">178</td><td class="source">  return a;</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source"> * Escape the given string of `html`.</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source"> * @param {String} html</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source"> * @return {String}</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">119</td><td class="hits">1</td><td class="source">exports.escape = function(html){</td></tr><tr class="hit"><td class="line">120</td><td class="hits">3</td><td class="source">  return String(html)</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">    .replace(/&amp;(?!\w+;)/g, '&amp;amp;')</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">    .replace(/&lt;/g, '&amp;lt;')</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">    .replace(/&gt;/g, '&amp;gt;')</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">    .replace(/&quot;/g, '&amp;quot;');</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source"> * Return a unique identifier with the given `len`.</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source"> *     utils.uid(10);</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source"> *     // =&gt; &quot;FDaS435D2z&quot;</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source"> * @param {Number} len</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source"> * @return {String}</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">139</td><td class="hits">1</td><td class="source">exports.uid = function(len) {</td></tr><tr class="hit"><td class="line">140</td><td class="hits">43</td><td class="source">  return crypto.randomBytes(Math.ceil(len * 3 / 4))</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">    .toString('base64')</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">    .slice(0, len);</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source"> * Sign the given `val` with `secret`.</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source"> * @param {String} val</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source"> * @param {String} secret</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source"> * @return {String}</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">154</td><td class="hits">1</td><td class="source">exports.sign = function(val, secret){</td></tr><tr class="hit"><td class="line">155</td><td class="hits">47</td><td class="source">  return val + '.' + crypto</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">    .createHmac('sha1', secret)</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">    .update(val)</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">    .digest('base64')</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">    .replace(/=+$/, '');</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source"> * Unsign and decode the given `val` with `secret`,</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source"> * returning `false` if the signature is invalid.</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source"> * @param {String} val</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source"> * @param {String} secret</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source"> * @return {String|Boolean}</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">172</td><td class="hits">1</td><td class="source">exports.unsign = function(val, secret){</td></tr><tr class="hit"><td class="line">173</td><td class="hits">17</td><td class="source">  var str = val.slice(0,val.lastIndexOf('.'));</td></tr><tr class="hit"><td class="line">174</td><td class="hits">17</td><td class="source">  return exports.sign(str, secret) == val</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">    ? str</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">    : false;</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source"> * Parse signed cookies, returning an object</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source"> * containing the decoded key/value pairs,</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source"> * while removing the signed key from `obj`.</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source"> * @param {Object} obj</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source"> * @return {Object}</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">189</td><td class="hits">1</td><td class="source">exports.parseSignedCookies = function(obj, secret){</td></tr><tr class="hit"><td class="line">190</td><td class="hits">8</td><td class="source">  var ret = {};</td></tr><tr class="hit"><td class="line">191</td><td class="hits">8</td><td class="source">  Object.keys(obj).forEach(function(key){</td></tr><tr class="hit"><td class="line">192</td><td class="hits">12</td><td class="source">    var val = obj[key]</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">      , signed = exports.unsign(val, secret);</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">195</td><td class="hits">12</td><td class="source">    if (signed) {</td></tr><tr class="hit"><td class="line">196</td><td class="hits">7</td><td class="source">      ret[key] = signed;</td></tr><tr class="hit"><td class="line">197</td><td class="hits">7</td><td class="source">      delete obj[key];</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">  });</td></tr><tr class="hit"><td class="line">200</td><td class="hits">8</td><td class="source">  return ret;</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source"> * Parse JSON cookies.</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source"> * @param {Object} obj</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source"> * @return {Object}</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">211</td><td class="hits">1</td><td class="source">exports.parseJSONCookies = function(obj){</td></tr><tr class="hit"><td class="line">212</td><td class="hits">16</td><td class="source">  Object.keys(obj).forEach(function(key){</td></tr><tr class="hit"><td class="line">213</td><td class="hits">12</td><td class="source">    var val = obj[key];</td></tr><tr class="hit"><td class="line">214</td><td class="hits">12</td><td class="source">    if (0 == val.indexOf('j:')) {</td></tr><tr class="hit"><td class="line">215</td><td class="hits">2</td><td class="source">      try {</td></tr><tr class="hit"><td class="line">216</td><td class="hits">2</td><td class="source">        obj[key] = JSON.parse(val.slice(2));</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">      } catch (err) {</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">        // nothing</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source">  });</td></tr><tr class="hit"><td class="line">222</td><td class="hits">16</td><td class="source">  return obj;</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source"> * Parse the given cookie string into an object.</td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source"> * @param {String} str</td></tr><tr><td class="line">229</td><td class="hits"></td><td class="source"> * @return {Object}</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">233</td><td class="hits">1</td><td class="source">exports.parseCookie = function(str){</td></tr><tr class="hit"><td class="line">234</td><td class="hits">14</td><td class="source">  var obj = {}</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">    , pairs = str.split(/[;,] */);</td></tr><tr class="hit"><td class="line">236</td><td class="hits">14</td><td class="source">  for (var i = 0, len = pairs.length; i &lt; len; ++i) {</td></tr><tr class="hit"><td class="line">237</td><td class="hits">19</td><td class="source">    var pair = pairs[i]</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">      , eqlIndex = pair.indexOf('=')</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source">      , key = pair.substr(0, eqlIndex).trim()</td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source">      , val = pair.substr(++eqlIndex, pair.length).trim();</td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source">    // quoted values</td></tr><tr class="hit"><td class="line">243</td><td class="hits">20</td><td class="source">    if ('&quot;' == val[0]) val = val.slice(1, -1);</td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source">    // only assign once</td></tr><tr class="hit"><td class="line">246</td><td class="hits">19</td><td class="source">    if (undefined == obj[key]) {</td></tr><tr class="hit"><td class="line">247</td><td class="hits">19</td><td class="source">      val = val.replace(/\+/g, ' ');</td></tr><tr class="hit"><td class="line">248</td><td class="hits">19</td><td class="source">      try {</td></tr><tr class="hit"><td class="line">249</td><td class="hits">19</td><td class="source">        obj[key] = decodeURIComponent(val);</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source">      } catch (err) {</td></tr><tr class="miss"><td class="line">251</td><td class="hits">0</td><td class="source">        if (err instanceof URIError) {</td></tr><tr class="miss"><td class="line">252</td><td class="hits">0</td><td class="source">          obj[key] = val;</td></tr><tr><td class="line">253</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">254</td><td class="hits">0</td><td class="source">          throw err;</td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source">  }</td></tr><tr class="hit"><td class="line">259</td><td class="hits">14</td><td class="source">  return obj;</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source"> * Serialize the given object into a cookie string.</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source"> *      utils.serializeCookie('name', 'tj', { httpOnly: true })</td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source"> *      // =&gt; &quot;name=tj; httpOnly&quot;</td></tr><tr><td class="line">267</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source"> * @param {String} name</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source"> * @param {String} val</td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source"> * @param {Object} obj</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source"> * @return {String}</td></tr><tr><td class="line">272</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">273</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">275</td><td class="hits">1</td><td class="source">exports.serializeCookie = function(name, val, obj){</td></tr><tr class="hit"><td class="line">276</td><td class="hits">33</td><td class="source">  var pairs = [name + '=' + encodeURIComponent(val)]</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source">    , obj = obj || {};</td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">279</td><td class="hits">33</td><td class="source">  if (obj.domain) pairs.push('domain=' + obj.domain);</td></tr><tr class="hit"><td class="line">280</td><td class="hits">62</td><td class="source">  if (obj.path) pairs.push('path=' + obj.path);</td></tr><tr class="hit"><td class="line">281</td><td class="hits">50</td><td class="source">  if (obj.expires) pairs.push('expires=' + obj.expires.toUTCString());</td></tr><tr class="hit"><td class="line">282</td><td class="hits">57</td><td class="source">  if (obj.httpOnly) pairs.push('httpOnly');</td></tr><tr class="hit"><td class="line">283</td><td class="hits">37</td><td class="source">  if (obj.secure) pairs.push('secure');</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">285</td><td class="hits">33</td><td class="source">  return pairs.join('; ');</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source"> * Pause `data` and `end` events on the given `obj`.</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source"> * Middleware performing async tasks _should_ utilize</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source"> * this utility (or similar), to re-emit data once</td></tr><tr><td class="line">292</td><td class="hits"></td><td class="source"> * the async operation has completed, otherwise these</td></tr><tr><td class="line">293</td><td class="hits"></td><td class="source"> * events may be lost.</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">295</td><td class="hits"></td><td class="source"> *      var pause = utils.pause(req);</td></tr><tr><td class="line">296</td><td class="hits"></td><td class="source"> *      fs.readFile(path, function(){</td></tr><tr><td class="line">297</td><td class="hits"></td><td class="source"> *         next();</td></tr><tr><td class="line">298</td><td class="hits"></td><td class="source"> *         pause.resume();</td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source"> *      });</td></tr><tr><td class="line">300</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">301</td><td class="hits"></td><td class="source"> * @param {Object} obj</td></tr><tr><td class="line">302</td><td class="hits"></td><td class="source"> * @return {Object}</td></tr><tr><td class="line">303</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">304</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">305</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">306</td><td class="hits">1</td><td class="source">exports.pause = function(obj){</td></tr><tr class="hit"><td class="line">307</td><td class="hits">7</td><td class="source">  var onData</td></tr><tr><td class="line">308</td><td class="hits"></td><td class="source">    , onEnd</td></tr><tr><td class="line">309</td><td class="hits"></td><td class="source">    , events = [];</td></tr><tr><td class="line">310</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">311</td><td class="hits"></td><td class="source">  // buffer data</td></tr><tr class="hit"><td class="line">312</td><td class="hits">7</td><td class="source">  obj.on('data', onData = function(data, encoding){</td></tr><tr class="miss"><td class="line">313</td><td class="hits">0</td><td class="source">    events.push(['data', data, encoding]);</td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">315</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">316</td><td class="hits"></td><td class="source">  // buffer end</td></tr><tr class="hit"><td class="line">317</td><td class="hits">7</td><td class="source">  obj.on('end', onEnd = function(data, encoding){</td></tr><tr class="hit"><td class="line">318</td><td class="hits">6</td><td class="source">    events.push(['end', data, encoding]);</td></tr><tr><td class="line">319</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">320</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">321</td><td class="hits">7</td><td class="source">  return {</td></tr><tr><td class="line">322</td><td class="hits"></td><td class="source">    end: function(){</td></tr><tr class="hit"><td class="line">323</td><td class="hits">6</td><td class="source">      obj.removeListener('data', onData);</td></tr><tr class="hit"><td class="line">324</td><td class="hits">6</td><td class="source">      obj.removeListener('end', onEnd);</td></tr><tr><td class="line">325</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">326</td><td class="hits"></td><td class="source">    resume: function(){</td></tr><tr class="hit"><td class="line">327</td><td class="hits">6</td><td class="source">      this.end();</td></tr><tr class="hit"><td class="line">328</td><td class="hits">6</td><td class="source">      for (var i = 0, len = events.length; i &lt; len; ++i) {</td></tr><tr class="hit"><td class="line">329</td><td class="hits">5</td><td class="source">        obj.emit.apply(obj, events[i]);</td></tr><tr><td class="line">330</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">331</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">332</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">333</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">334</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">335</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">336</td><td class="hits"></td><td class="source"> * Check `req` and `res` to see if it has been modified.</td></tr><tr><td class="line">337</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">338</td><td class="hits"></td><td class="source"> * @param {IncomingMessage} req</td></tr><tr><td class="line">339</td><td class="hits"></td><td class="source"> * @param {ServerResponse} res</td></tr><tr><td class="line">340</td><td class="hits"></td><td class="source"> * @return {Boolean}</td></tr><tr><td class="line">341</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">342</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">343</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">344</td><td class="hits">1</td><td class="source">exports.modified = function(req, res, headers) {</td></tr><tr class="hit"><td class="line">345</td><td class="hits">1</td><td class="source">  var headers = headers || res._headers || {}</td></tr><tr><td class="line">346</td><td class="hits"></td><td class="source">    , modifiedSince = req.headers['if-modified-since']</td></tr><tr><td class="line">347</td><td class="hits"></td><td class="source">    , lastModified = headers['last-modified']</td></tr><tr><td class="line">348</td><td class="hits"></td><td class="source">    , noneMatch = req.headers['if-none-match']</td></tr><tr><td class="line">349</td><td class="hits"></td><td class="source">    , etag = headers['etag'];</td></tr><tr><td class="line">350</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">351</td><td class="hits">1</td><td class="source">  if (noneMatch) noneMatch = noneMatch.split(/ *, */);</td></tr><tr><td class="line">352</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">353</td><td class="hits"></td><td class="source">  // check If-None-Match</td></tr><tr class="hit"><td class="line">354</td><td class="hits">1</td><td class="source">  if (noneMatch &amp;&amp; etag &amp;&amp; ~noneMatch.indexOf(etag)) {</td></tr><tr class="miss"><td class="line">355</td><td class="hits">0</td><td class="source">    return false;</td></tr><tr><td class="line">356</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">357</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">358</td><td class="hits"></td><td class="source">  // check If-Modified-Since</td></tr><tr class="hit"><td class="line">359</td><td class="hits">1</td><td class="source">  if (modifiedSince &amp;&amp; lastModified) {</td></tr><tr class="hit"><td class="line">360</td><td class="hits">1</td><td class="source">    modifiedSince = new Date(modifiedSince);</td></tr><tr class="hit"><td class="line">361</td><td class="hits">1</td><td class="source">    lastModified = new Date(lastModified);</td></tr><tr><td class="line">362</td><td class="hits"></td><td class="source">    // Ignore invalid dates</td></tr><tr class="hit"><td class="line">363</td><td class="hits">1</td><td class="source">    if (!isNaN(modifiedSince.getTime())) {</td></tr><tr class="hit"><td class="line">364</td><td class="hits">2</td><td class="source">      if (lastModified &lt;= modifiedSince) return false;</td></tr><tr><td class="line">365</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">366</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">367</td><td class="hits"></td><td class="source">  </td></tr><tr class="miss"><td class="line">368</td><td class="hits">0</td><td class="source">  return true;</td></tr><tr><td class="line">369</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">370</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">371</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">372</td><td class="hits"></td><td class="source"> * Strip `Content-*` headers from `res`.</td></tr><tr><td class="line">373</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">374</td><td class="hits"></td><td class="source"> * @param {ServerResponse} res</td></tr><tr><td class="line">375</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">376</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">377</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">378</td><td class="hits">1</td><td class="source">exports.removeContentHeaders = function(res){</td></tr><tr class="hit"><td class="line">379</td><td class="hits">1</td><td class="source">  Object.keys(res._headers).forEach(function(field){</td></tr><tr class="hit"><td class="line">380</td><td class="hits">6</td><td class="source">    if (0 == field.indexOf('content')) {</td></tr><tr class="hit"><td class="line">381</td><td class="hits">1</td><td class="source">      res.removeHeader(field);</td></tr><tr><td class="line">382</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">383</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">384</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">385</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">386</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">387</td><td class="hits"></td><td class="source"> * Check if `req` is a conditional GET request.</td></tr><tr><td class="line">388</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">389</td><td class="hits"></td><td class="source"> * @param {IncomingMessage} req</td></tr><tr><td class="line">390</td><td class="hits"></td><td class="source"> * @return {Boolean}</td></tr><tr><td class="line">391</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">392</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">393</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">394</td><td class="hits">1</td><td class="source">exports.conditionalGET = function(req) {</td></tr><tr class="hit"><td class="line">395</td><td class="hits">36</td><td class="source">  return req.headers['if-modified-since']</td></tr><tr><td class="line">396</td><td class="hits"></td><td class="source">    || req.headers['if-none-match'];</td></tr><tr><td class="line">397</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">398</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">399</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">400</td><td class="hits"></td><td class="source"> * Respond with 401 &quot;Unauthorized&quot;.</td></tr><tr><td class="line">401</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">402</td><td class="hits"></td><td class="source"> * @param {ServerResponse} res</td></tr><tr><td class="line">403</td><td class="hits"></td><td class="source"> * @param {String} realm</td></tr><tr><td class="line">404</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">405</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">406</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">407</td><td class="hits">1</td><td class="source">exports.unauthorized = function(res, realm) {</td></tr><tr class="hit"><td class="line">408</td><td class="hits">6</td><td class="source">  res.statusCode = 401;</td></tr><tr class="hit"><td class="line">409</td><td class="hits">6</td><td class="source">  res.setHeader('WWW-Authenticate', 'Basic realm=&quot;' + realm + '&quot;');</td></tr><tr class="hit"><td class="line">410</td><td class="hits">6</td><td class="source">  res.end('Unauthorized');</td></tr><tr><td class="line">411</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">412</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">413</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">414</td><td class="hits"></td><td class="source"> * Respond with 304 &quot;Not Modified&quot;.</td></tr><tr><td class="line">415</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">416</td><td class="hits"></td><td class="source"> * @param {ServerResponse} res</td></tr><tr><td class="line">417</td><td class="hits"></td><td class="source"> * @param {Object} headers</td></tr><tr><td class="line">418</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">419</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">420</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">421</td><td class="hits">1</td><td class="source">exports.notModified = function(res) {</td></tr><tr class="hit"><td class="line">422</td><td class="hits">1</td><td class="source">  exports.removeContentHeaders(res);</td></tr><tr class="hit"><td class="line">423</td><td class="hits">1</td><td class="source">  res.statusCode = 304;</td></tr><tr class="hit"><td class="line">424</td><td class="hits">1</td><td class="source">  res.end();</td></tr><tr><td class="line">425</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">426</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">427</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">428</td><td class="hits"></td><td class="source"> * Return an ETag in the form of `&quot;&lt;size&gt;-&lt;mtime&gt;&quot;`</td></tr><tr><td class="line">429</td><td class="hits"></td><td class="source"> * from the given `stat`.</td></tr><tr><td class="line">430</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">431</td><td class="hits"></td><td class="source"> * @param {Object} stat</td></tr><tr><td class="line">432</td><td class="hits"></td><td class="source"> * @return {String}</td></tr><tr><td class="line">433</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">434</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">435</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">436</td><td class="hits">1</td><td class="source">exports.etag = function(stat) {</td></tr><tr class="miss"><td class="line">437</td><td class="hits">0</td><td class="source">  return '&quot;' + stat.size + '-' + Number(stat.mtime) + '&quot;';</td></tr><tr><td class="line">438</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">439</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">440</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">441</td><td class="hits"></td><td class="source"> * Parse &quot;Range&quot; header `str` relative to the given file `size`.</td></tr><tr><td class="line">442</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">443</td><td class="hits"></td><td class="source"> * @param {Number} size</td></tr><tr><td class="line">444</td><td class="hits"></td><td class="source"> * @param {String} str</td></tr><tr><td class="line">445</td><td class="hits"></td><td class="source"> * @return {Array}</td></tr><tr><td class="line">446</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">447</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">448</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">449</td><td class="hits">1</td><td class="source">exports.parseRange = function(size, str){</td></tr><tr class="hit"><td class="line">450</td><td class="hits">15</td><td class="source">  var valid = true;</td></tr><tr class="hit"><td class="line">451</td><td class="hits">15</td><td class="source">  var arr = str.substr(6).split(',').map(function(range){</td></tr><tr class="hit"><td class="line">452</td><td class="hits">15</td><td class="source">    var range = range.split('-')</td></tr><tr><td class="line">453</td><td class="hits"></td><td class="source">      , start = parseInt(range[0], 10)</td></tr><tr><td class="line">454</td><td class="hits"></td><td class="source">      , end = parseInt(range[1], 10);</td></tr><tr><td class="line">455</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">456</td><td class="hits"></td><td class="source">    // -500</td></tr><tr class="hit"><td class="line">457</td><td class="hits">15</td><td class="source">    if (isNaN(start)) {</td></tr><tr class="hit"><td class="line">458</td><td class="hits">4</td><td class="source">      start = size - end;</td></tr><tr class="hit"><td class="line">459</td><td class="hits">4</td><td class="source">      end = size - 1;</td></tr><tr><td class="line">460</td><td class="hits"></td><td class="source">    // 500-</td></tr><tr class="hit"><td class="line">461</td><td class="hits">11</td><td class="source">    } else if (isNaN(end)) {</td></tr><tr class="hit"><td class="line">462</td><td class="hits">3</td><td class="source">      end = size - 1;</td></tr><tr><td class="line">463</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">464</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">465</td><td class="hits"></td><td class="source">    // Invalid</td></tr><tr class="hit"><td class="line">466</td><td class="hits">16</td><td class="source">    if (isNaN(start) || isNaN(end) || start &gt; end) valid = false;</td></tr><tr><td class="line">467</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">468</td><td class="hits">15</td><td class="source">    return { start: start, end: end };</td></tr><tr><td class="line">469</td><td class="hits"></td><td class="source">  });</td></tr><tr class="hit"><td class="line">470</td><td class="hits">15</td><td class="source">  return valid ? arr : undefined;</td></tr><tr><td class="line">471</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">472</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">473</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">474</td><td class="hits"></td><td class="source"> * Parse the given Cache-Control `str`.</td></tr><tr><td class="line">475</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">476</td><td class="hits"></td><td class="source"> * @param {String} str</td></tr><tr><td class="line">477</td><td class="hits"></td><td class="source"> * @return {Object}</td></tr><tr><td class="line">478</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">479</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">480</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">481</td><td class="hits">1</td><td class="source">exports.parseCacheControl = function(str){</td></tr><tr class="hit"><td class="line">482</td><td class="hits">26</td><td class="source">  var directives = str.split(',')</td></tr><tr><td class="line">483</td><td class="hits"></td><td class="source">    , obj = {};</td></tr><tr><td class="line">484</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">485</td><td class="hits">26</td><td class="source">  for(var i = 0, len = directives.length; i &lt; len; i++) {</td></tr><tr class="hit"><td class="line">486</td><td class="hits">37</td><td class="source">    var parts = directives[i].split('=')</td></tr><tr><td class="line">487</td><td class="hits"></td><td class="source">      , key = parts.shift().trim()</td></tr><tr><td class="line">488</td><td class="hits"></td><td class="source">      , val = parseInt(parts.shift(), 10);</td></tr><tr><td class="line">489</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">490</td><td class="hits">37</td><td class="source">    obj[key] = isNaN(val) ? true : val;</td></tr><tr><td class="line">491</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">492</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">493</td><td class="hits">26</td><td class="source">  return obj;</td></tr><tr><td class="line">494</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">495</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">496</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">497</td><td class="hits"></td><td class="source"> * Convert array-like object to an `Array`.</td></tr><tr><td class="line">498</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">499</td><td class="hits"></td><td class="source"> * node-bench measured &quot;16.5 times faster than Array.prototype.slice.call()&quot;</td></tr><tr><td class="line">500</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">501</td><td class="hits"></td><td class="source"> * @param {Object} obj</td></tr><tr><td class="line">502</td><td class="hits"></td><td class="source"> * @return {Array}</td></tr><tr><td class="line">503</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">504</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">505</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">506</td><td class="hits">1</td><td class="source">var toArray = exports.toArray = function(obj){</td></tr><tr class="miss"><td class="line">507</td><td class="hits">0</td><td class="source">  var len = obj.length</td></tr><tr><td class="line">508</td><td class="hits"></td><td class="source">    , arr = new Array(len);</td></tr><tr class="miss"><td class="line">509</td><td class="hits">0</td><td class="source">  for (var i = 0; i &lt; len; ++i) {</td></tr><tr class="miss"><td class="line">510</td><td class="hits">0</td><td class="source">    arr[i] = obj[i];</td></tr><tr><td class="line">511</td><td class="hits"></td><td class="source">  }</td></tr><tr class="miss"><td class="line">512</td><td class="hits">0</td><td class="source">  return arr;</td></tr><tr><td class="line">513</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="patch.js">patch.js</h2><div id="stats" class="high"><div class="percentage">90%</div><div class="sloc">21</div><div class="hits">19</div><div class="misses">2</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Connect</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 TJ Holowaychuk</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * MIT Licensed</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">var http = require('http')</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">  , res = http.ServerResponse.prototype</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  , setHeader = res.setHeader</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">  , _renderHeaders = res._renderHeaders</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">  , writeHead = res.writeHead;</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">// apply only once</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">if (!res._hasConnectPatch) {</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">   * Provide a public &quot;header sent&quot; flag</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">   * until node does.</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">   * @return {Boolean}</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">   * @api public</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">  res.__defineGetter__('headerSent', function(){</td></tr><tr class="hit"><td class="line">31</td><td class="hits">273</td><td class="source">    return this._header;</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">   * Set header `field` to `val`, special-casing</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">   * the `Set-Cookie` field for multiple support.</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">   * @param {String} field</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">   * @param {String} val</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">   * @api public</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">43</td><td class="hits">1</td><td class="source">  res.setHeader = function(field, val){</td></tr><tr class="hit"><td class="line">44</td><td class="hits">265</td><td class="source">    var key = field.toLowerCase()</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">      , prev;</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">    // special-case Set-Cookie</td></tr><tr class="hit"><td class="line">48</td><td class="hits">265</td><td class="source">    if (this._headers &amp;&amp; 'set-cookie' == key) {</td></tr><tr class="hit"><td class="line">49</td><td class="hits">3</td><td class="source">      if (prev = this.getHeader(field)) {</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">        val = Array.isArray(prev)</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">          ? prev.concat(val)</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">          : [prev, val];</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">    // charset</td></tr><tr class="hit"><td class="line">55</td><td class="hits">262</td><td class="source">    } else if ('content-type' == key &amp;&amp; this.charset) {</td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">      val += '; charset=' + this.charset;</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">59</td><td class="hits">265</td><td class="source">    return setHeader.call(this, field, val);</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">   * Proxy to emit &quot;header&quot; event.</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">66</td><td class="hits">1</td><td class="source">  res._renderHeaders = function(){</td></tr><tr class="hit"><td class="line">67</td><td class="hits">78</td><td class="source">    if (!this._emittedHeader) this.emit('header');</td></tr><tr class="hit"><td class="line">68</td><td class="hits">78</td><td class="source">    this._emittedHeader = true;</td></tr><tr class="hit"><td class="line">69</td><td class="hits">78</td><td class="source">    return _renderHeaders.call(this);</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">72</td><td class="hits">1</td><td class="source">  res.writeHead = function(){</td></tr><tr class="hit"><td class="line">73</td><td class="hits">256</td><td class="source">    if (!this._emittedHeader) this.emit('header');</td></tr><tr class="hit"><td class="line">74</td><td class="hits">128</td><td class="source">    this._emittedHeader = true;</td></tr><tr class="hit"><td class="line">75</td><td class="hits">128</td><td class="source">    return writeHead.apply(this, arguments);</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">78</td><td class="hits">1</td><td class="source">  res._hasConnectPatch = true;</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">}</td></tr></tbody></table></div><div class="file"><h2 id="middleware/basicAuth.js">middleware/basicAuth.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">28</div><div class="hits">28</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Connect - basicAuth</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright(c) 2010 Sencha Inc.</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 TJ Holowaychuk</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * MIT Licensed</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">var utils = require('../utils')</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  , unauthorized = utils.unauthorized;</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> * Basic Auth:</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> * Enfore basic authentication by providing a `callback(user, pass)`,</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> * which must return `true` in order to gain access. Alternatively an async</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> * method is provided as well, invoking `callback(user, pass, callback)`. Populates</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> * `req.user`. The final alternative is simply passing username / password</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> * strings.</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> *  Simple username and password</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> *     connect(connect.basicAuth('username', 'password'));</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> *  Callback verification</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> *     connect()</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> *       .use(connect.basicAuth(function(user, pass){</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> *         return 'tj' == user &amp; 'wahoo' == pass;</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> *       }))</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> *  Async callback verification, accepting `fn(err, user)`.</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> *     connect()</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> *       .use(connect.basicAuth(function(user, pass, fn){</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> *         User.authenticate({ user: user, pass: pass }, fn);</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> *       }))</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> * @param {Function|String} callback or username</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> * @param {String} realm</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">48</td><td class="hits">1</td><td class="source">module.exports = function basicAuth(callback, realm) {</td></tr><tr class="hit"><td class="line">49</td><td class="hits">3</td><td class="source">  var username, password;</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">  // user / pass strings</td></tr><tr class="hit"><td class="line">52</td><td class="hits">3</td><td class="source">  if ('string' == typeof callback) {</td></tr><tr class="hit"><td class="line">53</td><td class="hits">1</td><td class="source">    username = callback;</td></tr><tr class="hit"><td class="line">54</td><td class="hits">1</td><td class="source">    password = realm;</td></tr><tr class="hit"><td class="line">55</td><td class="hits">1</td><td class="source">    if ('string' != typeof password) throw new Error('password argument required');</td></tr><tr class="hit"><td class="line">56</td><td class="hits">1</td><td class="source">    realm = arguments[2];</td></tr><tr class="hit"><td class="line">57</td><td class="hits">1</td><td class="source">    callback = function(user, pass){</td></tr><tr class="hit"><td class="line">58</td><td class="hits">2</td><td class="source">      return user == username &amp;&amp; pass == password;</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">62</td><td class="hits">3</td><td class="source">  realm = realm || 'Authorization Required';</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">64</td><td class="hits">3</td><td class="source">  return function(req, res, next) {</td></tr><tr class="hit"><td class="line">65</td><td class="hits">9</td><td class="source">    var authorization = req.headers.authorization;</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">67</td><td class="hits">9</td><td class="source">    if (req.user) return next();</td></tr><tr class="hit"><td class="line">68</td><td class="hits">12</td><td class="source">    if (!authorization) return unauthorized(res, realm);</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">70</td><td class="hits">6</td><td class="source">    var parts = authorization.split(' ')</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">      , scheme = parts[0]</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">      , credentials = new Buffer(parts[1], 'base64').toString().split(':')</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">      , user = credentials[0]</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">      , pass = credentials[1];</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">76</td><td class="hits">6</td><td class="source">    if ('Basic' != scheme) return next(utils.error(400));</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">    // async</td></tr><tr class="hit"><td class="line">79</td><td class="hits">6</td><td class="source">    if (callback.length &gt;= 3) {</td></tr><tr class="hit"><td class="line">80</td><td class="hits">2</td><td class="source">      var pause = utils.pause(req);</td></tr><tr class="hit"><td class="line">81</td><td class="hits">2</td><td class="source">      callback(user, pass, function(err, user){</td></tr><tr class="hit"><td class="line">82</td><td class="hits">3</td><td class="source">        if (err || !user)  return unauthorized(res, realm);</td></tr><tr class="hit"><td class="line">83</td><td class="hits">1</td><td class="source">        req.user = user;</td></tr><tr class="hit"><td class="line">84</td><td class="hits">1</td><td class="source">        next();</td></tr><tr class="hit"><td class="line">85</td><td class="hits">1</td><td class="source">        pause.resume();</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">    // sync</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">89</td><td class="hits">4</td><td class="source">      if (callback(user, pass)) {</td></tr><tr class="hit"><td class="line">90</td><td class="hits">2</td><td class="source">        req.user = user;</td></tr><tr class="hit"><td class="line">91</td><td class="hits">2</td><td class="source">        next();</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"><td class="line">93</td><td class="hits">2</td><td class="source">        unauthorized(res, realm);</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="middleware/bodyParser.js">middleware/bodyParser.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">9</div><div class="hits">9</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Connect - bodyParser</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright(c) 2010 Sencha Inc.</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 TJ Holowaychuk</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * MIT Licensed</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">var multipart = require('./multipart')</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  , urlencoded = require('./urlencoded')</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">  , json = require('./json');</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> * Body parser:</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> * </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> *   Parse request bodies, supports _application/json_,</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> *   _application/x-www-form-urlencoded_, and _multipart/form-data_.</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> *   This is equivalent to: </td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> *     app.use(connect.json());</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> *     app.use(connect.urlencoded());</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> *     app.use(connect.multipart());</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> * Examples:</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> *      connect()</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> *        .use(connect.bodyParser())</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> *        .use(function(req, res) {</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> *          res.end('viewing user ' + req.body.user.name);</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> *        });</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> *      $ curl -d 'user[name]=tj' http://local/</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> *      $ curl -d '{&quot;user&quot;:{&quot;name&quot;:&quot;tj&quot;}}' -H &quot;Content-Type: application/json&quot; http://local/</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> *  View [json](json.html), [urlencoded](urlencoded.html), and [multipart](multipart.html) for more info.</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> * @param {Object} options</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> * @return {Function}</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">47</td><td class="hits">1</td><td class="source">exports = module.exports = function bodyParser(options){</td></tr><tr class="hit"><td class="line">48</td><td class="hits">6</td><td class="source">  var _urlencoded = urlencoded(options)</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">    , _multipart = multipart(options)</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">    , _json = json(options);</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">52</td><td class="hits">6</td><td class="source">  return function bodyParser(req, res, next) {</td></tr><tr class="hit"><td class="line">53</td><td class="hits">11</td><td class="source">    _json(req, res, function(err){</td></tr><tr class="hit"><td class="line">54</td><td class="hits">11</td><td class="source">      if (err) return next(err);</td></tr><tr class="hit"><td class="line">55</td><td class="hits">11</td><td class="source">      _urlencoded(req, res, function(err){</td></tr><tr class="hit"><td class="line">56</td><td class="hits">11</td><td class="source">        if (err) return next(err);</td></tr><tr class="hit"><td class="line">57</td><td class="hits">11</td><td class="source">        _multipart(req, res, next);</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="middleware/multipart.js">middleware/multipart.js</h2><div id="stats" class="high"><div class="percentage">94%</div><div class="sloc">34</div><div class="hits">32</div><div class="misses">2</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Connect - multipart</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright(c) 2010 Sencha Inc.</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 TJ Holowaychuk</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * MIT Licensed</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">var formidable = require('formidable')</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  , utils = require('../utils')</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">  , qs = require('qs');</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> * Multipart:</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> * </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> * Parse multipart/form-data request bodies,</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> * providing the parsed object as `req.body`</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> * and `req.files`.</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> * Configuration:</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> *  The options passed are merged with [formidable](https://github.com/felixge/node-formidable)'s</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> *  `IncomingForm` object, allowing you to configure the upload directory,</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> *  size limits, etc. For example if you wish to change the upload dir do the following.</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> *     app.use(connect.multipart({ uploadDir: path }));</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> * @param {Object} options</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> * @return {Function}</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">37</td><td class="hits">1</td><td class="source">exports = module.exports = function(options){</td></tr><tr class="hit"><td class="line">38</td><td class="hits">13</td><td class="source">  options = options || {};</td></tr><tr class="hit"><td class="line">39</td><td class="hits">13</td><td class="source">  return function multipart(req, res, next) {</td></tr><tr class="hit"><td class="line">40</td><td class="hits">24</td><td class="source">    if (req._body) return next();</td></tr><tr class="hit"><td class="line">41</td><td class="hits">20</td><td class="source">    req.body = req.body || {};</td></tr><tr class="hit"><td class="line">42</td><td class="hits">20</td><td class="source">    req.files = req.files || {};</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">    // ignore GET</td></tr><tr class="hit"><td class="line">45</td><td class="hits">21</td><td class="source">    if ('GET' == req.method || 'HEAD' == req.method) return next();</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">    // check Content-Type</td></tr><tr class="hit"><td class="line">48</td><td class="hits">22</td><td class="source">    if ('multipart/form-data' != utils.mime(req)) return next();</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">    // flag as parsed</td></tr><tr class="hit"><td class="line">51</td><td class="hits">16</td><td class="source">    req._body = true;</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">    // parse</td></tr><tr class="hit"><td class="line">54</td><td class="hits">16</td><td class="source">    var form = new formidable.IncomingForm</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">      , data = {}</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">      , files = {}</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">      , done;</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">59</td><td class="hits">16</td><td class="source">    Object.keys(options).forEach(function(key){</td></tr><tr class="hit"><td class="line">60</td><td class="hits">2</td><td class="source">      form[key] = options[key];</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">63</td><td class="hits">16</td><td class="source">    function ondata(name, val, data){</td></tr><tr class="hit"><td class="line">64</td><td class="hits">32</td><td class="source">      if (Array.isArray(data[name])) {</td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="source">        data[name].push(val);</td></tr><tr class="hit"><td class="line">66</td><td class="hits">32</td><td class="source">      } else if (data[name]) {</td></tr><tr class="hit"><td class="line">67</td><td class="hits">2</td><td class="source">        data[name] = [data[name], val];</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"><td class="line">69</td><td class="hits">30</td><td class="source">        data[name] = val;</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">73</td><td class="hits">16</td><td class="source">    form.on('field', function(name, val){</td></tr><tr class="hit"><td class="line">74</td><td class="hits">18</td><td class="source">      ondata(name, val, data);</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">77</td><td class="hits">16</td><td class="source">    form.on('file', function(name, val){</td></tr><tr class="hit"><td class="line">78</td><td class="hits">14</td><td class="source">      ondata(name, val, files);</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">81</td><td class="hits">16</td><td class="source">    form.on('error', function(err){</td></tr><tr class="hit"><td class="line">82</td><td class="hits">2</td><td class="source">      next(err);</td></tr><tr class="hit"><td class="line">83</td><td class="hits">2</td><td class="source">      done = true;</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">86</td><td class="hits">16</td><td class="source">    form.on('end', function(){</td></tr><tr class="hit"><td class="line">87</td><td class="hits">18</td><td class="source">      if (done) return;</td></tr><tr class="hit"><td class="line">88</td><td class="hits">14</td><td class="source">      try {</td></tr><tr class="hit"><td class="line">89</td><td class="hits">14</td><td class="source">        req.body = qs.parse(data);</td></tr><tr class="hit"><td class="line">90</td><td class="hits">14</td><td class="source">        req.files = qs.parse(files);</td></tr><tr class="hit"><td class="line">91</td><td class="hits">14</td><td class="source">        next();</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">      } catch (err) {</td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="source">        next(err);</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">97</td><td class="hits">16</td><td class="source">    form.parse(req);</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="middleware/urlencoded.js">middleware/urlencoded.js</h2><div id="stats" class="high"><div class="percentage">94%</div><div class="sloc">17</div><div class="hits">16</div><div class="misses">1</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Connect - urlencoded</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright(c) 2010 Sencha Inc.</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 TJ Holowaychuk</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * MIT Licensed</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">var utils = require('../utils')</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  , qs = require('qs');</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> * Urlencoded:</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> * </td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> *  Parse x-ww-form-urlencoded request bodies,</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> *  providing the parsed object as `req.body`.</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> * @param {Object} options</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> * @return {Function}</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">exports = module.exports = function(options){</td></tr><tr class="hit"><td class="line">28</td><td class="hits">7</td><td class="source">  options = options || {};</td></tr><tr class="hit"><td class="line">29</td><td class="hits">7</td><td class="source">  return function urlencoded(req, res, next) {</td></tr><tr class="hit"><td class="line">30</td><td class="hits">14</td><td class="source">    if (req._body) return next();</td></tr><tr class="hit"><td class="line">31</td><td class="hits">12</td><td class="source">    req.body = req.body || {};</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">    // ignore GET</td></tr><tr class="hit"><td class="line">34</td><td class="hits">12</td><td class="source">    if ('GET' == req.method || 'HEAD' == req.method) return next();</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">    // check Content-Type</td></tr><tr class="hit"><td class="line">37</td><td class="hits">22</td><td class="source">    if ('application/x-www-form-urlencoded' != utils.mime(req)) return next();</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">    // flag as parsed</td></tr><tr class="hit"><td class="line">40</td><td class="hits">2</td><td class="source">    req._body = true;</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">    // parse</td></tr><tr class="hit"><td class="line">43</td><td class="hits">2</td><td class="source">    var buf = '';</td></tr><tr class="hit"><td class="line">44</td><td class="hits">2</td><td class="source">    req.setEncoding('utf8');</td></tr><tr class="hit"><td class="line">45</td><td class="hits">4</td><td class="source">    req.on('data', function(chunk){ buf += chunk });</td></tr><tr class="hit"><td class="line">46</td><td class="hits">2</td><td class="source">    req.on('end', function(){</td></tr><tr class="hit"><td class="line">47</td><td class="hits">2</td><td class="source">      try {</td></tr><tr class="hit"><td class="line">48</td><td class="hits">2</td><td class="source">        req.body = buf.length</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">          ? qs.parse(buf)</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">          : {};</td></tr><tr class="hit"><td class="line">51</td><td class="hits">2</td><td class="source">        next();</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">      } catch (err){</td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="source">        next(err);</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="middleware/json.js">middleware/json.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">18</div><div class="hits">18</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Connect - json</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright(c) 2010 Sencha Inc.</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 TJ Holowaychuk</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * MIT Licensed</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">var utils = require('../utils');</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> * JSON:</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> * Parse JSON request bodies, providing the</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> * parsed object as `req.body`.</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> * @param {Object} options</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> * @return {Function}</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">26</td><td class="hits">1</td><td class="source">exports = module.exports = function(options){</td></tr><tr class="hit"><td class="line">27</td><td class="hits">8</td><td class="source">  options = options || {};</td></tr><tr class="hit"><td class="line">28</td><td class="hits">8</td><td class="source">  return function json(req, res, next) {</td></tr><tr class="hit"><td class="line">29</td><td class="hits">16</td><td class="source">    if (req._body) return next();</td></tr><tr class="hit"><td class="line">30</td><td class="hits">16</td><td class="source">    req.body = req.body || {};</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">    // ignore GET</td></tr><tr class="hit"><td class="line">33</td><td class="hits">17</td><td class="source">    if ('GET' == req.method || 'HEAD' == req.method) return next();</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">    // check Content-Type</td></tr><tr class="hit"><td class="line">36</td><td class="hits">26</td><td class="source">    if ('application/json' != utils.mime(req)) return next();</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">    // flag as parsed</td></tr><tr class="hit"><td class="line">39</td><td class="hits">4</td><td class="source">    req._body = true;</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">    // parse</td></tr><tr class="hit"><td class="line">42</td><td class="hits">4</td><td class="source">    var buf = '';</td></tr><tr class="hit"><td class="line">43</td><td class="hits">4</td><td class="source">    req.setEncoding('utf8');</td></tr><tr class="hit"><td class="line">44</td><td class="hits">8</td><td class="source">    req.on('data', function(chunk){ buf += chunk });</td></tr><tr class="hit"><td class="line">45</td><td class="hits">4</td><td class="source">    req.on('end', function(){</td></tr><tr class="hit"><td class="line">46</td><td class="hits">4</td><td class="source">      try {</td></tr><tr class="hit"><td class="line">47</td><td class="hits">4</td><td class="source">        req.body = buf.length</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">          ? JSON.parse(buf)</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">          : {};</td></tr><tr class="hit"><td class="line">50</td><td class="hits">2</td><td class="source">        next();</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">      } catch (err){</td></tr><tr class="hit"><td class="line">52</td><td class="hits">2</td><td class="source">        err.status = 400;</td></tr><tr class="hit"><td class="line">53</td><td class="hits">2</td><td class="source">        next(err);</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="middleware/compress.js">middleware/compress.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">35</div><div class="hits">35</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Connect - compress</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright(c) 2010 Sencha Inc.</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 TJ Holowaychuk</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * MIT Licensed</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">var zlib = require('zlib');</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> * Supported content-encoding methods.</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">exports.methods = {</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    gzip: zlib.createGzip</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">  , deflate: zlib.createDeflate</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> * Default filter function.</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">28</td><td class="hits">1</td><td class="source">exports.filter = function(req, res){</td></tr><tr class="hit"><td class="line">29</td><td class="hits">9</td><td class="source">  var type = res.getHeader('Content-Type') || '';</td></tr><tr class="hit"><td class="line">30</td><td class="hits">9</td><td class="source">  return type.match(/json|text|javascript/);</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> * Compress:</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> * Compress response data with gzip/deflate.</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> * Filter:</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> *  A `filter` callback function may be passed to</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> *  replace the default logic of:</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> *     exports.filter = function(req, res){</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> *       var type = res.getHeader('Content-Type') || '';</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> *       return type.match(/json|text|javascript/);</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> *     };</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> * Options:</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source"> *  All remaining options are passed to the gzip/deflate</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> *  creation functions. Consult node's docs for additional details.</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> *     - `chunkSize` (default: 16*1024)</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> *     - `windowBits`</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> *     - `level`: 0-9 where 0 is no compression, and 9 is slow but best compression</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> *     - `memLevel`: 1-9 low is slower but uses less memory, high is fast but uses more</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source"> *     - `strategy`: compression strategy</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> * @param {Object} options</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> * @return {Function}</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">64</td><td class="hits">1</td><td class="source">module.exports = function compress(options) {</td></tr><tr class="hit"><td class="line">65</td><td class="hits">1</td><td class="source">  var options = options || {}</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">    , names = Object.keys(exports.methods)</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">    , filter = options.filter || exports.filter;</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">69</td><td class="hits">1</td><td class="source">  return function(req, res, next){</td></tr><tr class="hit"><td class="line">70</td><td class="hits">9</td><td class="source">    var accept = req.headers['accept-encoding']</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">      , write = res.write</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">      , end = res.end</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">      , stream</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">      , method;</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">    // vary</td></tr><tr class="hit"><td class="line">77</td><td class="hits">9</td><td class="source">    res.setHeader('Vary', 'Accept-Encoding');</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">    // proxy</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">81</td><td class="hits">9</td><td class="source">    res.write = function(chunk, encoding){</td></tr><tr class="hit"><td class="line">82</td><td class="hits">14</td><td class="source">      if (!this.headerSent) this._implicitHeader();</td></tr><tr class="hit"><td class="line">83</td><td class="hits">7</td><td class="source">      return stream</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">        ? stream.write(chunk, encoding)</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">        : write.call(res, chunk, encoding);</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">88</td><td class="hits">9</td><td class="source">    res.end = function(chunk, encoding){</td></tr><tr class="hit"><td class="line">89</td><td class="hits">9</td><td class="source">      if (chunk) this.write(chunk, encoding);</td></tr><tr class="hit"><td class="line">90</td><td class="hits">9</td><td class="source">      return stream</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">        ? stream.end()</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">        : end.call(res);</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">95</td><td class="hits">9</td><td class="source">    res.on('header', function(){</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">      // default request filter</td></tr><tr class="hit"><td class="line">97</td><td class="hits">10</td><td class="source">      if (!filter(req, res)) return;</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">      // SHOULD use identity</td></tr><tr class="hit"><td class="line">100</td><td class="hits">9</td><td class="source">      if (!accept) return;</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">      // head</td></tr><tr class="hit"><td class="line">103</td><td class="hits">8</td><td class="source">      if ('HEAD' == req.method) return;</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">      // default to gzip</td></tr><tr class="hit"><td class="line">106</td><td class="hits">6</td><td class="source">      if ('*' == accept.trim()) method = 'gzip';</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">      // compression method</td></tr><tr class="hit"><td class="line">109</td><td class="hits">6</td><td class="source">      if (!method) {</td></tr><tr class="hit"><td class="line">110</td><td class="hits">6</td><td class="source">        for (var i = 0, len = names.length; i &lt; len; ++i) {</td></tr><tr class="hit"><td class="line">111</td><td class="hits">6</td><td class="source">          if (~accept.indexOf(names[i])) {</td></tr><tr class="hit"><td class="line">112</td><td class="hits">6</td><td class="source">            method = names[i];</td></tr><tr class="hit"><td class="line">113</td><td class="hits">6</td><td class="source">            break;</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">      // compression method</td></tr><tr class="hit"><td class="line">119</td><td class="hits">6</td><td class="source">      if (!method) return;</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">      // compression stream</td></tr><tr class="hit"><td class="line">122</td><td class="hits">6</td><td class="source">      stream = exports.methods[method](options);</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">      // header fields</td></tr><tr class="hit"><td class="line">125</td><td class="hits">6</td><td class="source">      res.setHeader('Content-Encoding', method);</td></tr><tr class="hit"><td class="line">126</td><td class="hits">6</td><td class="source">      res.removeHeader('Content-Length');</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">      // compression</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">130</td><td class="hits">6</td><td class="source">      stream.on('data', function(chunk){</td></tr><tr class="hit"><td class="line">131</td><td class="hits">12</td><td class="source">        write.call(res, chunk);</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">134</td><td class="hits">6</td><td class="source">      stream.on('end', function(){</td></tr><tr class="hit"><td class="line">135</td><td class="hits">6</td><td class="source">        end.call(res);</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">      </td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">140</td><td class="hits">9</td><td class="source">    next();</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">}</td></tr></tbody></table></div><div class="file"><h2 id="middleware/static.js">middleware/static.js</h2><div id="stats" class="high"><div class="percentage">90%</div><div class="sloc">77</div><div class="hits">70</div><div class="misses">7</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> * Connect - staticProvider</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Copyright(c) 2010 Sencha Inc.</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 TJ Holowaychuk</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * MIT Licensed</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">var fs = require('fs')</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">  , path = require('path')</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  , join = path.join</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">  , basename = path.basename</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">  , normalize = path.normalize</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">  , utils = require('../utils')</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">  , Buffer = require('buffer').Buffer</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">  , parse = require('url').parse</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">  , mime = require('mime');</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> * Static:</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> *   Static file server with the given `root` path.</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> * Examples:</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> *     var oneDay = 86400000;</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> *     connect()</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> *       .use(connect.static(__dirname + '/public'))</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> *     connect()</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> *       .use(connect.static(__dirname + '/public', { maxAge: oneDay }))</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> * Options:</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> *    - `maxAge`   Browser cache maxAge in milliseconds. defaults to 0</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> *    - `hidden`   Allow transfer of hidden files. defaults to false</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> *    - `redirect`   Redirect to trailing &quot;/&quot; when the pathname is a dir</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> * @param {String} root</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> * @param {Object} options</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> * @return {Function}</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">49</td><td class="hits">1</td><td class="source">exports = module.exports = function static(root, options){</td></tr><tr class="hit"><td class="line">50</td><td class="hits">6</td><td class="source">  options = options || {};</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">  // root required</td></tr><tr class="hit"><td class="line">53</td><td class="hits">6</td><td class="source">  if (!root) throw new Error('static() root path required');</td></tr><tr class="hit"><td class="line">54</td><td class="hits">6</td><td class="source">  options.root = root;</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">56</td><td class="hits">6</td><td class="source">  return function static(req, res, next) {</td></tr><tr class="hit"><td class="line">57</td><td class="hits">36</td><td class="source">    options.path = req.url;</td></tr><tr class="hit"><td class="line">58</td><td class="hits">36</td><td class="source">    options.getOnly = true;</td></tr><tr class="hit"><td class="line">59</td><td class="hits">36</td><td class="source">    send(req, res, next, options);</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source"> * Expose mime module.</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> * </td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> * If you wish to extend the mime table use this</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source"> * reference to the &quot;mime&quot; module in the npm registry.</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">70</td><td class="hits">1</td><td class="source">exports.mime = mime;</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> * decodeURIComponent.</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> * Allows V8 to only deoptimize this fn instead of all</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source"> * of send().</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source"> * @param {String} path</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">82</td><td class="hits">1</td><td class="source">function decode(path){</td></tr><tr class="hit"><td class="line">83</td><td class="hits">36</td><td class="source">  try {</td></tr><tr class="hit"><td class="line">84</td><td class="hits">36</td><td class="source">    return decodeURIComponent(path);</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">  } catch (err) {</td></tr><tr class="hit"><td class="line">86</td><td class="hits">1</td><td class="source">    return err;</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source"> * Attempt to tranfer the requested file to `res`.</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source"> * @param {ServerRequest}</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source"> * @param {ServerResponse}</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source"> * @param {Function} next</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source"> * @param {Object} options</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">100</td><td class="hits">1</td><td class="source">var send = exports.send = function(req, res, next, options){</td></tr><tr class="hit"><td class="line">101</td><td class="hits">36</td><td class="source">  options = options || {};</td></tr><tr class="hit"><td class="line">102</td><td class="hits">36</td><td class="source">  if (!options.path) throw new Error('path required');</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">  // setup</td></tr><tr class="hit"><td class="line">105</td><td class="hits">36</td><td class="source">  var maxAge = options.maxAge || 0</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">    , ranges = req.headers.range</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">    , head = 'HEAD' == req.method</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">    , get = 'GET' == req.method</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">    , root = options.root ? normalize(options.root) : null</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">    , redirect = false === options.redirect ? false : true</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">    , getOnly = options.getOnly</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">    , fn = options.callback</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">    , hidden = options.hidden</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">    , done;</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">  // replace next() with callback when available</td></tr><tr class="hit"><td class="line">117</td><td class="hits">36</td><td class="source">  if (fn) next = fn;</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">  // ignore non-GET requests</td></tr><tr class="hit"><td class="line">120</td><td class="hits">36</td><td class="source">  if (getOnly &amp;&amp; !get &amp;&amp; !head) return next();</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">  // parse url</td></tr><tr class="hit"><td class="line">123</td><td class="hits">36</td><td class="source">  var url = parse(options.path)</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">    , path = decode(url.pathname)</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">    , type;</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">127</td><td class="hits">37</td><td class="source">  if ('URIError: URI malformed' == path) return next(utils.error(400));</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">  // null byte(s)</td></tr><tr class="hit"><td class="line">130</td><td class="hits">35</td><td class="source">  if (~path.indexOf('\0')) return next(utils.error(400));</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">  // when root is not given, consider .. malicious</td></tr><tr class="hit"><td class="line">133</td><td class="hits">35</td><td class="source">  if (!root &amp;&amp; ~path.indexOf('..')) return next(utils.error(403));</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">  </td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">  // index.html support</td></tr><tr class="hit"><td class="line">136</td><td class="hits">36</td><td class="source">  if (normalize('/') == path[path.length - 1]) path += 'index.html';</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">  </td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">  // join / normalize from optional root dir</td></tr><tr class="hit"><td class="line">139</td><td class="hits">35</td><td class="source">  path = normalize(join(root, path));</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">  // malicious path</td></tr><tr class="hit"><td class="line">142</td><td class="hits">37</td><td class="source">  if (root &amp;&amp; 0 != path.indexOf(root)) return next(utils.error(403));</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">  // &quot;hidden&quot; file</td></tr><tr class="hit"><td class="line">145</td><td class="hits">34</td><td class="source">  if (!hidden &amp;&amp; '.' == basename(path)[0]) return next();</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">147</td><td class="hits">32</td><td class="source">  fs.stat(path, function(err, stat){</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source">    // mime type</td></tr><tr class="hit"><td class="line">149</td><td class="hits">32</td><td class="source">    type = mime.lookup(path);</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">    // ignore ENOENT</td></tr><tr class="hit"><td class="line">152</td><td class="hits">32</td><td class="source">    if (err) {</td></tr><tr class="hit"><td class="line">153</td><td class="hits">1</td><td class="source">      if (fn) return fn(err);</td></tr><tr class="hit"><td class="line">154</td><td class="hits">1</td><td class="source">      return ('ENOENT' == err.code || 'ENAMETOOLONG' == err.code)</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">        ? next()</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">        : next(err);</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">    // redirect directory in case index.html is present</td></tr><tr class="hit"><td class="line">158</td><td class="hits">31</td><td class="source">    } else if (stat.isDirectory()) {</td></tr><tr class="hit"><td class="line">159</td><td class="hits">1</td><td class="source">      if (!redirect) return next();</td></tr><tr class="hit"><td class="line">160</td><td class="hits">1</td><td class="source">      res.statusCode = 301;</td></tr><tr class="hit"><td class="line">161</td><td class="hits">1</td><td class="source">      res.setHeader('Location', url.pathname + '/');</td></tr><tr class="hit"><td class="line">162</td><td class="hits">1</td><td class="source">      res.end('Redirecting to ' + url.pathname + '/');</td></tr><tr class="hit"><td class="line">163</td><td class="hits">1</td><td class="source">      return;</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">    // header fields</td></tr><tr class="hit"><td class="line">167</td><td class="hits">60</td><td class="source">    if (!res.getHeader('Date')) res.setHeader('Date', new Date().toUTCString());</td></tr><tr class="hit"><td class="line">168</td><td class="hits">58</td><td class="source">    if (!res.getHeader('Cache-Control')) res.setHeader('Cache-Control', 'public, max-age=' + (maxAge / 1000));</td></tr><tr class="hit"><td class="line">169</td><td class="hits">60</td><td class="source">    if (!res.getHeader('Last-Modified')) res.setHeader('Last-Modified', stat.mtime.toUTCString());</td></tr><tr class="hit"><td class="line">170</td><td class="hits">30</td><td class="source">    if (!res.getHeader('Content-Type')) {</td></tr><tr class="hit"><td class="line">171</td><td class="hits">30</td><td class="source">      var charset = mime.charsets.lookup(type);</td></tr><tr class="hit"><td class="line">172</td><td class="hits">30</td><td class="source">      res.setHeader('Content-Type', type + (charset ? '; charset=' + charset : ''));</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">174</td><td class="hits">30</td><td class="source">    res.setHeader('Accept-Ranges', 'bytes');</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">    // conditional GET support</td></tr><tr class="hit"><td class="line">177</td><td class="hits">30</td><td class="source">    if (utils.conditionalGET(req)) {</td></tr><tr class="hit"><td class="line">178</td><td class="hits">1</td><td class="source">      if (!utils.modified(req, res)) {</td></tr><tr class="hit"><td class="line">179</td><td class="hits">1</td><td class="source">        req.emit('static');</td></tr><tr class="hit"><td class="line">180</td><td class="hits">1</td><td class="source">        return utils.notModified(res);</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">184</td><td class="hits">29</td><td class="source">    var opts = {}</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">      , len = stat.size;</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">    // we have a Range request</td></tr><tr class="hit"><td class="line">188</td><td class="hits">29</td><td class="source">    if (ranges) {</td></tr><tr class="hit"><td class="line">189</td><td class="hits">7</td><td class="source">      ranges = utils.parseRange(stat.size, ranges);</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">      // valid</td></tr><tr class="hit"><td class="line">191</td><td class="hits">7</td><td class="source">      if (ranges) {</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">        // TODO: stream options</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">        // TODO: multiple support</td></tr><tr class="hit"><td class="line">194</td><td class="hits">6</td><td class="source">        opts.start = ranges[0].start;</td></tr><tr class="hit"><td class="line">195</td><td class="hits">6</td><td class="source">        opts.end = ranges[0].end;</td></tr><tr class="hit"><td class="line">196</td><td class="hits">6</td><td class="source">        len = Math.min(len, opts.end - opts.start + 1);</td></tr><tr class="hit"><td class="line">197</td><td class="hits">6</td><td class="source">        res.statusCode = 206;</td></tr><tr class="hit"><td class="line">198</td><td class="hits">6</td><td class="source">        res.setHeader('Content-Range', 'bytes '</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">          + opts.start</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">          + '-'</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">          + opts.end</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">          + '/'</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">          + stat.size);</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">      // invalid range</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"><td class="line">206</td><td class="hits">1</td><td class="source">        return next(utils.error(416));</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">210</td><td class="hits">28</td><td class="source">    res.setHeader('Content-Length', len);</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">    // transfer</td></tr><tr class="hit"><td class="line">213</td><td class="hits">32</td><td class="source">    if (head) return res.end();</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">    // stream</td></tr><tr class="hit"><td class="line">216</td><td class="hits">24</td><td class="source">    var stream = fs.createReadStream(path, opts);</td></tr><tr class="hit"><td class="line">217</td><td class="hits">24</td><td class="source">    req.emit('static', stream);</td></tr><tr class="hit"><td class="line">218</td><td class="hits">24</td><td class="source">    req.on('close', stream.destroy.bind(stream));</td></tr><tr class="hit"><td class="line">219</td><td class="hits">24</td><td class="source">    stream.pipe(res);</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source">    // callback</td></tr><tr class="hit"><td class="line">222</td><td class="hits">24</td><td class="source">    if (fn) {</td></tr><tr class="miss"><td class="line">223</td><td class="hits">0</td><td class="source">      function callback(err) { done || fn(err); done = true }</td></tr><tr class="miss"><td class="line">224</td><td class="hits">0</td><td class="source">      req.on('close', callback);</td></tr><tr class="miss"><td class="line">225</td><td class="hits">0</td><td class="source">      req.socket.on('error', callback);</td></tr><tr class="miss"><td class="line">226</td><td class="hits">0</td><td class="source">      stream.on('error', callback);</td></tr><tr class="miss"><td class="line">227</td><td class="hits">0</td><td class="source">      stream.on('end', callback);</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="hit"><td class="line">229</td><td class="hits">24</td><td class="source">      stream.on('error', function(err){</td></tr><tr class="hit"><td class="line">230</td><td class="hits">1</td><td class="source">        if (res.headerSent) {</td></tr><tr class="miss"><td class="line">231</td><td class="hits">0</td><td class="source">          console.error(err.stack);</td></tr><tr class="miss"><td class="line">232</td><td class="hits">0</td><td class="source">          req.destroy();</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"><td class="line">234</td><td class="hits">1</td><td class="source">          next(err);</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="middleware/limit.js">middleware/limit.js</h2><div id="stats" class="high"><div class="percentage">88%</div><div class="sloc">17</div><div class="hits">15</div><div class="misses">2</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Connect - limit</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 TJ Holowaychuk</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * MIT Licensed</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">var utils = require('../utils');</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> * Limit:</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> *   Limit request bodies to the given size in `bytes`.</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> *   A string representation of the bytesize may also be passed,</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> *   for example &quot;5mb&quot;, &quot;200kb&quot;, &quot;1gb&quot;, etc.</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> *     connect()</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> *       .use(connect.limit('5.5mb'))</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> *       .use(handleImageUpload)</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> * @param {Number|String} bytes</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> * @return {Function}</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">31</td><td class="hits">1</td><td class="source">module.exports = function limit(bytes){</td></tr><tr class="hit"><td class="line">32</td><td class="hits">2</td><td class="source">  if ('string' == typeof bytes) bytes = parse(bytes);</td></tr><tr class="hit"><td class="line">33</td><td class="hits">1</td><td class="source">  if ('number' != typeof bytes) throw new Error('limit() bytes required');</td></tr><tr class="hit"><td class="line">34</td><td class="hits">1</td><td class="source">  return function limit(req, res, next){</td></tr><tr class="hit"><td class="line">35</td><td class="hits">2</td><td class="source">    var received = 0</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">      , len = req.headers['content-length']</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        ? parseInt(req.headers['content-length'], 10)</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        : null;</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    // self-awareness</td></tr><tr class="hit"><td class="line">41</td><td class="hits">2</td><td class="source">    if (req._limit) return next();</td></tr><tr class="hit"><td class="line">42</td><td class="hits">2</td><td class="source">    req._limit = true;</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">    // limit by content-length</td></tr><tr class="hit"><td class="line">45</td><td class="hits">3</td><td class="source">    if (len &amp;&amp; len &gt; bytes) return next(utils.error(413));</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">    // limit</td></tr><tr class="hit"><td class="line">48</td><td class="hits">1</td><td class="source">    req.on('data', function(chunk){</td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">      received += chunk.length;</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">      if (received &gt; bytes) req.destroy();</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">53</td><td class="hits">1</td><td class="source">    next();</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> * Parse byte `size` string.</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> * @param {String} size</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> * @return {Number}</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">65</td><td class="hits">1</td><td class="source">function parse(size) {</td></tr><tr class="hit"><td class="line">66</td><td class="hits">1</td><td class="source">  var parts = size.match(/^(\d+(?:\.\d+)?) *(kb|mb|gb)$/)</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">    , n = parseFloat(parts[1])</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">    , type = parts[2];</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">70</td><td class="hits">1</td><td class="source">  var map = {</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">      kb: 1024</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">    , mb: 1024 * 1024</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">    , gb: 1024 * 1024 * 1024</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">76</td><td class="hits">1</td><td class="source">  return map[type] * n;</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">}</td></tr></tbody></table></div><div class="file"><h2 id="middleware/query.js">middleware/query.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">5</div><div class="hits">5</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Connect - query</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 TJ Holowaychuk</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 Sencha Inc.</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * MIT Licensed</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">var qs = require('qs')</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  , parse = require('url').parse;</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> * Query:</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> * Automatically parse the query-string when available,</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> * populating the `req.query` object.</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> * Examples:</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> *     connect()</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> *       .use(connect.query())</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> *       .use(function(req, res){</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> *         res.end(JSON.stringify(req.query));</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> *       });</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> * @return {Function}</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">34</td><td class="hits">1</td><td class="source">module.exports = function query(){</td></tr><tr class="hit"><td class="line">35</td><td class="hits">1</td><td class="source">  return function query(req, res, next){</td></tr><tr class="hit"><td class="line">36</td><td class="hits">2</td><td class="source">    req.query = ~req.url.indexOf('?')</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">      ? qs.parse(parse(req.url).query)</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">      : {};</td></tr><tr class="hit"><td class="line">39</td><td class="hits">2</td><td class="source">    next();</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="middleware/responseTime.js">middleware/responseTime.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">9</div><div class="hits">9</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Connect - responseTime</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 TJ Holowaychuk</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * MIT Licensed</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * Reponse time:</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> * Adds the `X-Response-Time` header displaying the response</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> * duration in milliseconds.</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> * @return {Function}</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">module.exports = function responseTime(){</td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">  return function(req, res, next){</td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">    var start = new Date;</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">22</td><td class="hits">1</td><td class="source">    if (res._responseTime) return next();</td></tr><tr class="hit"><td class="line">23</td><td class="hits">1</td><td class="source">    res._responseTime = true;</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">25</td><td class="hits">1</td><td class="source">    res.on('header', function(header){</td></tr><tr class="hit"><td class="line">26</td><td class="hits">1</td><td class="source">      var duration = new Date - start;</td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">      res.setHeader('X-Response-time', duration + 'ms');</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">    next();</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="middleware/cookieParser.js">middleware/cookieParser.js</h2><div id="stats" class="high"><div class="percentage">94%</div><div class="sloc">17</div><div class="hits">16</div><div class="misses">1</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Connect - cookieParser</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright(c) 2010 Sencha Inc.</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 TJ Holowaychuk</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * MIT Licensed</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">var utils = require('./../utils');</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> * Cookie parser:</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> * Parse _Cookie_ header and populate `req.cookies`</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> * with an object keyed by the cookie names. Optionally</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> * you may enabled signed cookie support by passing</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> * a `secret` string, which assigns `req.secret` so</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> * it may be used by other middleware such as `session()`.</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> * Examples:</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> *     connect()</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> *       .use(connect.cookieParser('keyboard cat'))</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> *       .use(function(req, res, next){</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> *         res.end(JSON.stringify(req.cookies));</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> *       })</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> * @param {String} secret</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> * @return {Function}</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">37</td><td class="hits">1</td><td class="source">module.exports = function cookieParser(secret){</td></tr><tr class="hit"><td class="line">38</td><td class="hits">29</td><td class="source">  return function cookieParser(req, res, next) {</td></tr><tr class="hit"><td class="line">39</td><td class="hits">35</td><td class="source">    var cookie = req.headers.cookie;</td></tr><tr class="hit"><td class="line">40</td><td class="hits">35</td><td class="source">    if (req.cookies) return next();</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">42</td><td class="hits">35</td><td class="source">    req.secret = secret;</td></tr><tr class="hit"><td class="line">43</td><td class="hits">35</td><td class="source">    req.cookies = {};</td></tr><tr class="hit"><td class="line">44</td><td class="hits">35</td><td class="source">    req.signedCookies = {};</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">    </td></tr><tr class="hit"><td class="line">46</td><td class="hits">35</td><td class="source">    if (cookie) {</td></tr><tr class="hit"><td class="line">47</td><td class="hits">8</td><td class="source">      try {</td></tr><tr class="hit"><td class="line">48</td><td class="hits">8</td><td class="source">        req.cookies = utils.parseCookie(cookie);</td></tr><tr class="hit"><td class="line">49</td><td class="hits">8</td><td class="source">        if (secret) {</td></tr><tr class="hit"><td class="line">50</td><td class="hits">8</td><td class="source">          req.signedCookies = utils.parseSignedCookies(req.cookies, secret);</td></tr><tr class="hit"><td class="line">51</td><td class="hits">8</td><td class="source">          req.signedCookies = utils.parseJSONCookies(req.signedCookies);</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">53</td><td class="hits">8</td><td class="source">        req.cookies = utils.parseJSONCookies(req.cookies);</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">      } catch (err) {</td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">        return next(err);</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">58</td><td class="hits">35</td><td class="source">    next();</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="middleware/session.js">middleware/session.js</h2><div id="stats" class="high"><div class="percentage">86%</div><div class="sloc">67</div><div class="hits">58</div><div class="misses">9</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Connect - session</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright(c) 2010 Sencha Inc.</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 TJ Holowaychuk</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * MIT Licensed</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">var Session = require('./session/session')</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  , debug = require('debug')('connect:session')</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">  , MemoryStore = require('./session/memory')</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">  , Cookie = require('./session/cookie')</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">  , Store = require('./session/store')</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">  , utils = require('./../utils')</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">  , parse = require('url').parse</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">  , crypto = require('crypto');</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">// environment</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">24</td><td class="hits">1</td><td class="source">var env = process.env.NODE_ENV;</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> * Expose the middleware.</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">exports = module.exports = session;</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> * Expose constructors.</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">36</td><td class="hits">1</td><td class="source">exports.Store = Store;</td></tr><tr class="hit"><td class="line">37</td><td class="hits">1</td><td class="source">exports.Cookie = Cookie;</td></tr><tr class="hit"><td class="line">38</td><td class="hits">1</td><td class="source">exports.Session = Session;</td></tr><tr class="hit"><td class="line">39</td><td class="hits">1</td><td class="source">exports.MemoryStore = MemoryStore;</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> * Warning message for `MemoryStore` usage in production.</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">45</td><td class="hits">1</td><td class="source">var warning = 'Warning: connection.session() MemoryStore is not\n'</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">  + 'designed for a production environment, as it will leak\n'</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">  + 'memory, and obviously only work within a single process.';</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source"> * Session:</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> * </td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> *   Setup session store with the given `options`.</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> *   Session data is _not_ saved in the cookie itself, however</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> *   cookies are used, so we must use the [cookieParser()](cookieParser.html)</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> *   middleware _before_ `session()`.</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> * Examples:</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> *     connect()</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> *       .use(connect.cookieParser('keyboard cat'))</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source"> *       .use(connect.session({ key: 'sid', cookie: { secure: true }}))</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source"> * Options:</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> *   - `key` cookie name defaulting to `connect.sid`</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source"> *   - `store` session store instance</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> *   - `cookie` session cookie settings, defaulting to `{ path: '/', httpOnly: true, maxAge: null }`</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> *   - `proxy` trust the reverse proxy when setting secure cookies (via &quot;x-forwarded-proto&quot;)</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> * Cookie option:</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> *  By default `cookie.maxAge` is `null`, meaning no &quot;expires&quot; parameter is set</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source"> *  so the cookie becomes a browser-session cookie. When the user closes the </td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> *  browser the cookie (and session) will be removed.</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> * ## req.session</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source"> *  To store or access session data, simply use the request property `req.session`,</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source"> *  which is (generally) serialized as JSON by the store, so nested objects </td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source"> *  are typically fine. For example below is a user-specific view counter:</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source"> *       connect()</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source"> *         .use(connect.favicon())</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source"> *         .use(connect.cookieParser('keyboard cat'))</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source"> *         .use(connect.session({ cookie: { maxAge: 60000 }}))</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source"> *         .use(function(req, res, next){</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source"> *           var sess = req.session;</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source"> *           if (sess.views) {</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source"> *             res.setHeader('Content-Type', 'text/html');</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source"> *             res.write('&lt;p&gt;views: ' + sess.views + '&lt;/p&gt;');</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source"> *             res.write('&lt;p&gt;expires in: ' + (sess.cookie.maxAge / 1000) + 's&lt;/p&gt;');</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source"> *             res.end();</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source"> *             sess.views++;</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source"> *           } else {</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source"> *             sess.views = 1;</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source"> *             res.end('welcome to the session demo. refresh!');</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source"> *           }</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source"> *         }</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source"> *       )).listen(3000);</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source"> * ## Session#regenerate()</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source"> *  To regenerate the session simply invoke the method, once complete</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source"> *  a new SID and `Session` instance will be initialized at `req.session`.</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source"> *      req.session.regenerate(function(err){</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source"> *        // will have a new session here</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source"> *      });</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source"> * ## Session#destroy()</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source"> *  Destroys the session, removing `req.session`, will be re-generated next request.</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source"> *      req.session.destroy(function(err){</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source"> *        // cannot access session here</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source"> *      });</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source"> * </td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source"> * ## Session#reload()</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source"> *  Reloads the session data.</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source"> *      req.session.reload(function(err){</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source"> *        // session updated</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source"> *      });</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source"> * ## Session#save()</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source"> *  Save the session.</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source"> *      req.session.save(function(err){</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source"> *        // session saved</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source"> *      });</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source"> * ## Session#touch()</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source"> *   Updates the `.maxAge`, and `.lastAccess` properties. Typically this is</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source"> *   not necessary to call, as the session middleware does this for you.</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source"> * ## Session#cookie</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source"> *  Each session has a unique cookie object accompany it. This allows</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source"> *  you to alter the session cookie per visitor. For example we can</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source"> *  set `req.session.cookie.expires` to `false` to enable the cookie</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source"> *  to remain for only the duration of the user-agent.</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source"> * ## Session#maxAge</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source"> *  Alternatively `req.session.cookie.maxAge` will return the time</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source"> *  remaining in milliseconds, which we may also re-assign a new value</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source"> *  to adjust the `.expires` property appropriately. The following</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source"> *  are essentially equivalent</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source"> *     var hour = 3600000;</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source"> *     req.session.cookie.expires = new Date(Date.now() + hour);</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source"> *     req.session.cookie.maxAge = hour;</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source"> * For example when `maxAge` is set to `60000` (one minute), and 30 seconds</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source"> * has elapsed it will return `30000` until the current request has completed,</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source"> * at which time `req.session.touch()` is called to update `req.session.lastAccess`,</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source"> * and reset `req.session.maxAge` to its original value.</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source"> *     req.session.cookie.maxAge;</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source"> *     // =&gt; 30000</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source"> * Session Store Implementation:</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source"> * Every session store _must_ implement the following methods</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source"> *    - `.get(sid, callback)`</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source"> *    - `.set(sid, session, callback)`</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source"> *    - `.destroy(sid, callback)`</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source"> * Recommended methods include, but are not limited to:</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source"> *    - `.length(callback)`</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source"> *    - `.clear(callback)`</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source"> * For an example implementation view the [connect-redis](https://github.com/visionmedia/connect-redis) repo.</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source"> * @param {Object} options</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source"> * @return {Function}</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">186</td><td class="hits">1</td><td class="source">function session(options){</td></tr><tr class="hit"><td class="line">187</td><td class="hits">15</td><td class="source">  var options = options || {}</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">    , key = options.key || 'connect.sid'</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">    , store = options.store || new MemoryStore</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">    , cookie = options.cookie</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">    , trustProxy = options.proxy;</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">  // notify user that this store is not</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">  // meant for a production environment</td></tr><tr class="hit"><td class="line">195</td><td class="hits">15</td><td class="source">  if ('production' == env &amp;&amp; store instanceof MemoryStore) {</td></tr><tr class="miss"><td class="line">196</td><td class="hits">0</td><td class="source">    console.warn(warning);</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">  // generates the new session</td></tr><tr class="hit"><td class="line">200</td><td class="hits">15</td><td class="source">  store.generate = function(req){</td></tr><tr class="hit"><td class="line">201</td><td class="hits">21</td><td class="source">    req.sessionID = utils.uid(24);</td></tr><tr class="hit"><td class="line">202</td><td class="hits">21</td><td class="source">    req.session = new Session(req);</td></tr><tr class="hit"><td class="line">203</td><td class="hits">21</td><td class="source">    req.session.cookie = new Cookie(req, cookie);</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">206</td><td class="hits">15</td><td class="source">  return function session(req, res, next) {</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">    // self-awareness</td></tr><tr class="hit"><td class="line">208</td><td class="hits">24</td><td class="source">    if (req.session) return next();</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">    // ensure secret is available or bail</td></tr><tr class="hit"><td class="line">211</td><td class="hits">24</td><td class="source">    if (!req.secret) throw new Error('connect.cookieParser(&quot;secret&quot;) required for security when using sessions');</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source">    // parse url</td></tr><tr class="hit"><td class="line">214</td><td class="hits">24</td><td class="source">    var url = parse(req.url)</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">      , path = url.pathname</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">      , sessionIsNew;</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">    // expose store</td></tr><tr class="hit"><td class="line">219</td><td class="hits">24</td><td class="source">    req.sessionStore = store;</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source">    // set-cookie</td></tr><tr class="hit"><td class="line">222</td><td class="hits">24</td><td class="source">    res.on('header', function(){</td></tr><tr class="hit"><td class="line">223</td><td class="hits">25</td><td class="source">      if (!req.session) return;</td></tr><tr class="hit"><td class="line">224</td><td class="hits">23</td><td class="source">      var cookie = req.session.cookie</td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source">        , proto = (req.headers['x-forwarded-proto'] || '').toLowerCase()</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source">        , tls = req.connection.encrypted || (trustProxy &amp;&amp; 'https' == proto)</td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source">        , secured = cookie.secure &amp;&amp; tls;</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">229</td><td class="hits"></td><td class="source">      // browser-session cookies only set-cookie once</td></tr><tr class="hit"><td class="line">230</td><td class="hits">24</td><td class="source">      if (null == cookie.expires &amp;&amp; !sessionIsNew) return;</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">      // only send secure cookies via https</td></tr><tr class="hit"><td class="line">233</td><td class="hits">24</td><td class="source">      if (cookie.secure &amp;&amp; !secured) return debug('not secured');</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">235</td><td class="hits">20</td><td class="source">      debug('set %s to %s', key, req.sessionID);</td></tr><tr class="hit"><td class="line">236</td><td class="hits">20</td><td class="source">      res.setHeader('Set-Cookie', cookie.serialize(key, req.sessionID));</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source">    // proxy end() to commit the session</td></tr><tr class="hit"><td class="line">240</td><td class="hits">24</td><td class="source">    var end = res.end;</td></tr><tr class="hit"><td class="line">241</td><td class="hits">24</td><td class="source">    res.end = function(data, encoding){</td></tr><tr class="hit"><td class="line">242</td><td class="hits">24</td><td class="source">      res.end = end;</td></tr><tr class="hit"><td class="line">243</td><td class="hits">25</td><td class="source">      if (!req.session) return res.end(data, encoding);</td></tr><tr class="hit"><td class="line">244</td><td class="hits">23</td><td class="source">      debug('saving');</td></tr><tr class="hit"><td class="line">245</td><td class="hits">23</td><td class="source">      req.session.resetMaxAge();</td></tr><tr class="hit"><td class="line">246</td><td class="hits">23</td><td class="source">      req.session.save(function(){</td></tr><tr class="hit"><td class="line">247</td><td class="hits">23</td><td class="source">        debug('saved');</td></tr><tr class="hit"><td class="line">248</td><td class="hits">23</td><td class="source">        res.end(data, encoding);</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source">    // generate the session</td></tr><tr class="hit"><td class="line">253</td><td class="hits">24</td><td class="source">    function generate() {</td></tr><tr class="hit"><td class="line">254</td><td class="hits">19</td><td class="source">      sessionIsNew = true;</td></tr><tr class="hit"><td class="line">255</td><td class="hits">19</td><td class="source">      store.generate(req);</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source">    // get the sessionID from the cookie</td></tr><tr class="hit"><td class="line">259</td><td class="hits">24</td><td class="source">    req.sessionID = req.signedCookies[key];</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source">    // generate a session if the browser doesn't send a sessionID</td></tr><tr class="hit"><td class="line">262</td><td class="hits">24</td><td class="source">    if (!req.sessionID) {</td></tr><tr class="hit"><td class="line">263</td><td class="hits">19</td><td class="source">      debug('no SID sent, generating session');</td></tr><tr class="hit"><td class="line">264</td><td class="hits">19</td><td class="source">      generate();</td></tr><tr class="hit"><td class="line">265</td><td class="hits">19</td><td class="source">      next();</td></tr><tr class="hit"><td class="line">266</td><td class="hits">19</td><td class="source">      return;</td></tr><tr><td class="line">267</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">    // generate the session object</td></tr><tr class="hit"><td class="line">270</td><td class="hits">5</td><td class="source">    var pause = utils.pause(req);</td></tr><tr class="hit"><td class="line">271</td><td class="hits">5</td><td class="source">    debug('fetching %s', req.sessionID);</td></tr><tr class="hit"><td class="line">272</td><td class="hits">5</td><td class="source">    store.get(req.sessionID, function(err, sess){</td></tr><tr><td class="line">273</td><td class="hits"></td><td class="source">      // proxy to resume() events</td></tr><tr class="hit"><td class="line">274</td><td class="hits">5</td><td class="source">      var _next = next;</td></tr><tr class="hit"><td class="line">275</td><td class="hits">5</td><td class="source">      next = function(err){</td></tr><tr class="hit"><td class="line">276</td><td class="hits">5</td><td class="source">        _next(err);</td></tr><tr class="hit"><td class="line">277</td><td class="hits">5</td><td class="source">        pause.resume();</td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">279</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source">      // error handling</td></tr><tr class="hit"><td class="line">281</td><td class="hits">5</td><td class="source">      if (err) {</td></tr><tr class="miss"><td class="line">282</td><td class="hits">0</td><td class="source">        debug('error');</td></tr><tr class="miss"><td class="line">283</td><td class="hits">0</td><td class="source">        if ('ENOENT' == err.code) {</td></tr><tr class="miss"><td class="line">284</td><td class="hits">0</td><td class="source">          generate();</td></tr><tr class="miss"><td class="line">285</td><td class="hits">0</td><td class="source">          next();</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">287</td><td class="hits">0</td><td class="source">          next(err);</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source">      // no session</td></tr><tr class="hit"><td class="line">290</td><td class="hits">5</td><td class="source">      } else if (!sess) {</td></tr><tr class="miss"><td class="line">291</td><td class="hits">0</td><td class="source">        debug('no session found');</td></tr><tr class="miss"><td class="line">292</td><td class="hits">0</td><td class="source">        generate();</td></tr><tr class="miss"><td class="line">293</td><td class="hits">0</td><td class="source">        next();</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source">      // populate req.session</td></tr><tr><td class="line">295</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="hit"><td class="line">296</td><td class="hits">5</td><td class="source">        debug('session found');</td></tr><tr class="hit"><td class="line">297</td><td class="hits">5</td><td class="source">        store.createSession(req, sess);</td></tr><tr class="hit"><td class="line">298</td><td class="hits">5</td><td class="source">        next();</td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">300</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">301</td><td class="hits"></td><td class="source">  };</td></tr><tr class="hit"><td class="line">302</td><td class="hits">1</td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="middleware/session/session.js">middleware/session/session.js</h2><div id="stats" class="high"><div class="percentage">75%</div><div class="sloc">33</div><div class="hits">25</div><div class="misses">8</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Connect - session - Session</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright(c) 2010 Sencha Inc.</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 TJ Holowaychuk</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * MIT Licensed</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">var utils = require('../../utils')</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  , Cookie = require('./cookie');</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> * Create a new `Session` with the given request and `data`.</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> * @param {IncomingRequest} req</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> * @param {Object} data</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">24</td><td class="hits">1</td><td class="source">var Session = module.exports = function Session(req, data) {</td></tr><tr class="hit"><td class="line">25</td><td class="hits">26</td><td class="source">  Object.defineProperty(this, 'req', { value: req });</td></tr><tr class="hit"><td class="line">26</td><td class="hits">26</td><td class="source">  Object.defineProperty(this, 'id', { value: req.sessionID });</td></tr><tr class="hit"><td class="line">27</td><td class="hits">26</td><td class="source">  if ('object' == typeof data) {</td></tr><tr class="hit"><td class="line">28</td><td class="hits">5</td><td class="source">    utils.merge(this, data);</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">  } else {</td></tr><tr class="hit"><td class="line">30</td><td class="hits">21</td><td class="source">    this.lastAccess = Date.now();</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> * Update `.lastAccess` timestamp,</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> * and reset `.cookie.maxAge` to prevent</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> * the cookie from expiring when the</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> * session is still active.</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> * @return {Session} for chaining</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">44</td><td class="hits">1</td><td class="source">Session.prototype.touch = function(){</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">  return this</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">    .resetLastAccess()</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">    .resetMaxAge();</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> * Update `.lastAccess` timestamp.</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> * @return {Session} for chaining</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">57</td><td class="hits">1</td><td class="source">Session.prototype.resetLastAccess = function(){</td></tr><tr class="hit"><td class="line">58</td><td class="hits">5</td><td class="source">  this.lastAccess = Date.now();</td></tr><tr class="hit"><td class="line">59</td><td class="hits">5</td><td class="source">  return this;</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> * Reset `.maxAge` to `.originalMaxAge`.</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> * @return {Session} for chaining</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">69</td><td class="hits">1</td><td class="source">Session.prototype.resetMaxAge = function(){</td></tr><tr class="hit"><td class="line">70</td><td class="hits">23</td><td class="source">  this.cookie.maxAge = this.cookie.originalMaxAge;</td></tr><tr class="hit"><td class="line">71</td><td class="hits">23</td><td class="source">  return this;</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> * Save the session data with optional callback `fn(err)`.</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> * @param {Function} fn</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source"> * @return {Session} for chaining</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">82</td><td class="hits">1</td><td class="source">Session.prototype.save = function(fn){</td></tr><tr class="hit"><td class="line">83</td><td class="hits">23</td><td class="source">  this.req.sessionStore.set(this.id, this, fn || function(){});</td></tr><tr class="hit"><td class="line">84</td><td class="hits">23</td><td class="source">  return this;</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source"> * Re-loads the session data _without_ altering</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source"> * the maxAge or lastAccess properties. Invokes the</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source"> * callback `fn(err)`, after which time if no exception</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source"> * has occurred the `req.session` property will be</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source"> * a new `Session` object, although representing the</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source"> * same session.</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source"> * @param {Function} fn</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source"> * @return {Session} for chaining</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">100</td><td class="hits">1</td><td class="source">Session.prototype.reload = function(fn){</td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="source">  var req = this.req</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">    , store = this.req.sessionStore;</td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="source">  store.get(this.id, function(err, sess){</td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="source">    if (err) return fn(err);</td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="source">    if (!sess) return fn(new Error('failed to load session'));</td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="source">    store.createSession(req, sess);</td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="source">    fn();</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">  });</td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="source">  return this;</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source"> * Destroy `this` session.</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source"> * @param {Function} fn</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source"> * @return {Session} for chaining</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">120</td><td class="hits">1</td><td class="source">Session.prototype.destroy = function(fn){</td></tr><tr class="hit"><td class="line">121</td><td class="hits">1</td><td class="source">  delete this.req.session;</td></tr><tr class="hit"><td class="line">122</td><td class="hits">1</td><td class="source">  this.req.sessionStore.destroy(this.id, fn);</td></tr><tr class="hit"><td class="line">123</td><td class="hits">1</td><td class="source">  return this;</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source"> * Regenerate this request's session.</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source"> * @param {Function} fn</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source"> * @return {Session} for chaining</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">134</td><td class="hits">1</td><td class="source">Session.prototype.regenerate = function(fn){</td></tr><tr class="hit"><td class="line">135</td><td class="hits">2</td><td class="source">  this.req.sessionStore.regenerate(this.req, fn);</td></tr><tr class="hit"><td class="line">136</td><td class="hits">2</td><td class="source">  return this;</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="middleware/session/cookie.js">middleware/session/cookie.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">18</div><div class="hits">18</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Connect - session - Cookie</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright(c) 2010 Sencha Inc.</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 TJ Holowaychuk</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * MIT Licensed</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">var utils = require('../../utils');</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> * Initialize a new `Cookie` with the given `options`.</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> * @param {IncomingMessage} req</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> * @param {Object} options</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">23</td><td class="hits">1</td><td class="source">var Cookie = module.exports = function Cookie(req, options) {</td></tr><tr class="hit"><td class="line">24</td><td class="hits">37</td><td class="source">  this.path = '/';</td></tr><tr class="hit"><td class="line">25</td><td class="hits">37</td><td class="source">  this.maxAge = null;</td></tr><tr class="hit"><td class="line">26</td><td class="hits">37</td><td class="source">  this.httpOnly = true;</td></tr><tr class="hit"><td class="line">27</td><td class="hits">61</td><td class="source">  if (options) utils.merge(this, options);</td></tr><tr class="hit"><td class="line">28</td><td class="hits">37</td><td class="source">  Object.defineProperty(this, 'req', { value: req });</td></tr><tr class="hit"><td class="line">29</td><td class="hits">37</td><td class="source">  this.originalMaxAge = undefined == this.originalMaxAge</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    ? this.maxAge</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">    : this.originalMaxAge;</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> * Prototype.</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">38</td><td class="hits">1</td><td class="source">Cookie.prototype = {</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">   * Set expires `date`.</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">   * @param {Date} date</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">   * @api public</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">  </td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">  set expires(date) {</td></tr><tr class="hit"><td class="line">48</td><td class="hits">86</td><td class="source">    this._expires = date;</td></tr><tr class="hit"><td class="line">49</td><td class="hits">86</td><td class="source">    this.originalMaxAge = this.maxAge;</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">   * Get expires `date`.</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">   * @return {Date}</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">   * @api public</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">  get expires() {</td></tr><tr class="hit"><td class="line">60</td><td class="hits">241</td><td class="source">    return this._expires;</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">  </td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">   * Set expires via max-age in `ms`.</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">   * @param {Number} ms</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">   * @api public</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">  </td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">  set maxAge(ms) {</td></tr><tr class="hit"><td class="line">71</td><td class="hits">75</td><td class="source">    this.expires = 'number' == typeof ms</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">      ? new Date(Date.now() + ms)</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">      : ms;</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">   * Get expires max-age in `ms`.</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">   * @return {Number}</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">   * @api public</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">  get maxAge() {</td></tr><tr class="hit"><td class="line">84</td><td class="hits">105</td><td class="source">    return this.expires instanceof Date</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">      ? this.expires.valueOf() - Date.now()</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">      : this.expires;</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">   * Return cookie data object.</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">   * @return {Object}</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">   * @api private</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">  get data() {</td></tr><tr class="hit"><td class="line">97</td><td class="hits">43</td><td class="source">    return {</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">        originalMaxAge: this.originalMaxAge</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">      , expires: this._expires</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">      , secure: this.secure</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">      , httpOnly: this.httpOnly</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">      , domain: this.domain</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">      , path: this.path</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">   * Return a serialized cookie string.</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">   * @return {String}</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">   * @api public</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">  serialize: function(name, val){</td></tr><tr class="hit"><td class="line">115</td><td class="hits">20</td><td class="source">    val = utils.sign(val, this.req.secret);</td></tr><tr class="hit"><td class="line">116</td><td class="hits">20</td><td class="source">    return utils.serializeCookie(name, val, this.data);</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">  },</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">  /**</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">   * Return JSON representation of this cookie.</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">   * @return {Object}</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">   * @api private</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">   */</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">  </td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">  toJSON: function(){</td></tr><tr class="hit"><td class="line">127</td><td class="hits">23</td><td class="source">    return this.data;</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="middleware/session/memory.js">middleware/session/memory.js</h2><div id="stats" class="medium"><div class="percentage">74%</div><div class="sloc">35</div><div class="hits">26</div><div class="misses">9</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Connect - session - MemoryStore</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright(c) 2010 Sencha Inc.</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 TJ Holowaychuk</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * MIT Licensed</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">var Store = require('./store')</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  , utils = require('../../utils')</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">  , Session = require('./session');</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> * Initialize a new `MemoryStore`.</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">23</td><td class="hits">1</td><td class="source">var MemoryStore = module.exports = function MemoryStore() {</td></tr><tr class="hit"><td class="line">24</td><td class="hits">15</td><td class="source">  this.sessions = {};</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> * Inherit from `Store.prototype`.</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">31</td><td class="hits">1</td><td class="source">MemoryStore.prototype.__proto__ = Store.prototype;</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> * Attempt to fetch session by the given `sid`.</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> * @param {String} sid</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> * @param {Function} fn</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">41</td><td class="hits">1</td><td class="source">MemoryStore.prototype.get = function(sid, fn){</td></tr><tr class="hit"><td class="line">42</td><td class="hits">5</td><td class="source">  var self = this;</td></tr><tr class="hit"><td class="line">43</td><td class="hits">5</td><td class="source">  process.nextTick(function(){</td></tr><tr class="hit"><td class="line">44</td><td class="hits">5</td><td class="source">    var expires</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">      , sess = self.sessions[sid];</td></tr><tr class="hit"><td class="line">46</td><td class="hits">5</td><td class="source">    if (sess) {</td></tr><tr class="hit"><td class="line">47</td><td class="hits">5</td><td class="source">      sess = JSON.parse(sess);</td></tr><tr class="hit"><td class="line">48</td><td class="hits">5</td><td class="source">      expires = 'string' == typeof sess.cookie.expires</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">        ? new Date(sess.cookie.expires)</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">        : sess.cookie.expires;</td></tr><tr class="hit"><td class="line">51</td><td class="hits">5</td><td class="source">      if (!expires || new Date &lt; expires) {</td></tr><tr class="hit"><td class="line">52</td><td class="hits">5</td><td class="source">        fn(null, sess);</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">        self.destroy(sid, fn);</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">      fn();</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> * Commit the given `sess` object associated with the given `sid`.</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> * @param {String} sid</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> * @param {Session} sess</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source"> * @param {Function} fn</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">71</td><td class="hits">1</td><td class="source">MemoryStore.prototype.set = function(sid, sess, fn){</td></tr><tr class="hit"><td class="line">72</td><td class="hits">23</td><td class="source">  var self = this;</td></tr><tr class="hit"><td class="line">73</td><td class="hits">23</td><td class="source">  process.nextTick(function(){</td></tr><tr class="hit"><td class="line">74</td><td class="hits">23</td><td class="source">    self.sessions[sid] = JSON.stringify(sess);</td></tr><tr class="hit"><td class="line">75</td><td class="hits">23</td><td class="source">    fn &amp;&amp; fn();</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source"> * Destroy the session associated with the given `sid`.</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source"> * @param {String} sid</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">86</td><td class="hits">1</td><td class="source">MemoryStore.prototype.destroy = function(sid, fn){</td></tr><tr class="hit"><td class="line">87</td><td class="hits">3</td><td class="source">  var self = this;</td></tr><tr class="hit"><td class="line">88</td><td class="hits">3</td><td class="source">  process.nextTick(function(){</td></tr><tr class="hit"><td class="line">89</td><td class="hits">3</td><td class="source">    delete self.sessions[sid];</td></tr><tr class="hit"><td class="line">90</td><td class="hits">3</td><td class="source">    fn &amp;&amp; fn();</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source"> * Invoke the given callback `fn` with all active sessions.</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source"> * @param {Function} fn</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">101</td><td class="hits">1</td><td class="source">MemoryStore.prototype.all = function(fn){</td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="source">  var arr = []</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">    , keys = Object.keys(this.sessions);</td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="source">  for (var i = 0, len = keys.length; i &lt; len; ++i) {</td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="source">    arr.push(this.sessions[keys[i]]);</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">  }</td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="source">  fn(null, arr);</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source"> * Clear all sessions.</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source"> * @param {Function} fn</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">117</td><td class="hits">1</td><td class="source">MemoryStore.prototype.clear = function(fn){</td></tr><tr class="miss"><td class="line">118</td><td class="hits">0</td><td class="source">  this.sessions = {};</td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="source">  fn &amp;&amp; fn();</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source"> * Fetch number of sessions.</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source"> * @param {Function} fn</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">129</td><td class="hits">1</td><td class="source">MemoryStore.prototype.length = function(fn){</td></tr><tr class="miss"><td class="line">130</td><td class="hits">0</td><td class="source">  fn(null, Object.keys(this.sessions).length);</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="middleware/session/store.js">middleware/session/store.js</h2><div id="stats" class="medium"><div class="percentage">70%</div><div class="sloc">24</div><div class="hits">17</div><div class="misses">7</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Connect - session - Store</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright(c) 2010 Sencha Inc.</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 TJ Holowaychuk</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> * MIT Licensed</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">var EventEmitter = require('events').EventEmitter</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  , Session = require('./session')</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">  , Cookie = require('./cookie')</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">  , utils = require('../../utils');</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> * Initialize abstract `Store`.</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">24</td><td class="hits">1</td><td class="source">var Store = module.exports = function Store(options){};</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> * Inherit from `EventEmitter.prototype`.</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">Store.prototype.__proto__ = EventEmitter.prototype;</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> * Re-generate the given requests's session.</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> * @param {IncomingRequest} req</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> * @return {Function} fn</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">40</td><td class="hits">1</td><td class="source">Store.prototype.regenerate = function(req, fn){</td></tr><tr class="hit"><td class="line">41</td><td class="hits">2</td><td class="source">  var self = this;</td></tr><tr class="hit"><td class="line">42</td><td class="hits">2</td><td class="source">  this.destroy(req.sessionID, function(err){</td></tr><tr class="hit"><td class="line">43</td><td class="hits">2</td><td class="source">    self.generate(req);</td></tr><tr class="hit"><td class="line">44</td><td class="hits">2</td><td class="source">    fn(err);</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> * Load a `Session` instance via the given `sid`</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source"> * and invoke the callback `fn(err, sess)`.</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> * @param {String} sid</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> * @param {Function} fn</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">57</td><td class="hits">1</td><td class="source">Store.prototype.load = function(sid, fn){</td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">  var self = this;</td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">  this.get(sid, function(err, sess){</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">    if (err) return fn(err);</td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="source">    if (!sess) return fn();</td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="source">    var req = { sessionID: sid, sessionStore: self };</td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="source">    sess = self.createSession(req, sess, false);</td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="source">    fn(null, sess);</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> * Create session from JSON `sess` data.</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> * @param {IncomingRequest} req</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source"> * @param {Object} sess</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> * @return {Session}</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">77</td><td class="hits">1</td><td class="source">Store.prototype.createSession = function(req, sess, update){</td></tr><tr class="hit"><td class="line">78</td><td class="hits">5</td><td class="source">  var expires = sess.cookie.expires</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">    , orig = sess.cookie.originalMaxAge</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">    , update = null == update ? true : false;</td></tr><tr class="hit"><td class="line">81</td><td class="hits">5</td><td class="source">  sess.cookie = new Cookie(req, sess.cookie);</td></tr><tr class="hit"><td class="line">82</td><td class="hits">9</td><td class="source">  if ('string' == typeof expires) sess.cookie.expires = new Date(expires);</td></tr><tr class="hit"><td class="line">83</td><td class="hits">5</td><td class="source">  sess.cookie.originalMaxAge = orig;</td></tr><tr class="hit"><td class="line">84</td><td class="hits">5</td><td class="source">  req.session = new Session(req, sess);</td></tr><tr class="hit"><td class="line">85</td><td class="hits">10</td><td class="source">  if (update) req.session.resetLastAccess();</td></tr><tr class="hit"><td class="line">86</td><td class="hits">5</td><td class="source">  return req.session;</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="middleware/staticCache.js">middleware/staticCache.js</h2><div id="stats" class="high"><div class="percentage">85%</div><div class="sloc">54</div><div class="hits">46</div><div class="misses">8</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Connect - staticCache</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 Sencha Inc.</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * MIT Licensed</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">var http = require('http')</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">  , utils = require('../utils')</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  , Cache = require('../cache')</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">  , url = require('url')</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">  , fs = require('fs');</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> * Static cache:</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> * Enables a memory cache layer on top of</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> * the `static()` middleware, serving popular</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> * static files.</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> * By default a maximum of 128 objects are</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> * held in cache, with a max of 256k each,</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> * totalling ~32mb.</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> * A Least-Recently-Used (LRU) cache algo</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> * is implemented through the `Cache` object,</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> * simply rotating cache objects as they are</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> * hit. This means that increasingly popular</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> * objects maintain their positions while</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> * others get shoved out of the stack and</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> * garbage collected.</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> * Benchmarks:</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> *     static(): 2700 rps</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> *     node-static: 5300 rps</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> *     static() + staticCache(): 7500 rps</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> * Options:</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> *   - `maxObjects`  max cache objects [128]</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> *   - `maxLength`  max cache object length 256kb</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> * @param {Type} name</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> * @return {Type}</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">53</td><td class="hits">1</td><td class="source">module.exports = function staticCache(options){</td></tr><tr class="hit"><td class="line">54</td><td class="hits">3</td><td class="source">  var options = options || {}</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">    , cache = new Cache(options.maxObjects || 128)</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">    , maxlen = options.maxLength || 1024 * 256;</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">58</td><td class="hits">3</td><td class="source">  return function staticCache(req, res, next){</td></tr><tr class="hit"><td class="line">59</td><td class="hits">10</td><td class="source">    var path = url.parse(req.url).pathname</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">      , ranges = req.headers.range</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">      , hit = cache.get(path)</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">      , hitCC</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">      , uaCC</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">      , header</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">      , age;</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">67</td><td class="hits">10</td><td class="source">    function miss() {</td></tr><tr class="hit"><td class="line">68</td><td class="hits">4</td><td class="source">      res.setHeader('X-Cache', 'MISS');</td></tr><tr class="hit"><td class="line">69</td><td class="hits">4</td><td class="source">      next();</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">    // cache static</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">    // TODO: change from staticCache() -&gt; static()</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">    // and make this work for any request</td></tr><tr class="hit"><td class="line">75</td><td class="hits">10</td><td class="source">    req.on('static', function(stream){</td></tr><tr class="hit"><td class="line">76</td><td class="hits">2</td><td class="source">      var headers = res._headers</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">        , cc = utils.parseCacheControl(headers['cache-control'] || '')</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">        , contentLength = headers['content-length']</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">        , hit;</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">      // ignore larger files</td></tr><tr class="hit"><td class="line">82</td><td class="hits">2</td><td class="source">      if (!contentLength || contentLength &gt; maxlen) return;</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">      // dont cache items we shouldn't be</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">      // TODO: real support for must-revalidate / no-cache</td></tr><tr class="hit"><td class="line">86</td><td class="hits">2</td><td class="source">      if ( cc['no-cache']</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">        || cc['no-store']</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">        || cc['private']</td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="source">        || cc['must-revalidate']) return;</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">      // if already in cache then validate</td></tr><tr class="hit"><td class="line">92</td><td class="hits">2</td><td class="source">      if (hit = cache.get(path)){</td></tr><tr class="hit"><td class="line">93</td><td class="hits">1</td><td class="source">        if (headers.etag == hit[0].etag) {</td></tr><tr class="hit"><td class="line">94</td><td class="hits">1</td><td class="source">          hit[0].date = new Date;</td></tr><tr class="hit"><td class="line">95</td><td class="hits">1</td><td class="source">          return;</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">97</td><td class="hits">0</td><td class="source">          cache.remove(path);</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">      // validation notifiactions don't contain a steam</td></tr><tr class="hit"><td class="line">102</td><td class="hits">1</td><td class="source">      if (null == stream) return;</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">      // add the cache object</td></tr><tr class="hit"><td class="line">105</td><td class="hits">1</td><td class="source">      var arr = cache.add(path);</td></tr><tr class="hit"><td class="line">106</td><td class="hits">1</td><td class="source">      arr.push(headers);</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">      // store the chunks</td></tr><tr class="hit"><td class="line">109</td><td class="hits">1</td><td class="source">      stream.on('data', function(chunk){</td></tr><tr class="hit"><td class="line">110</td><td class="hits">1</td><td class="source">        arr.push(chunk);</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">      // flag it as complete</td></tr><tr class="hit"><td class="line">114</td><td class="hits">1</td><td class="source">      stream.on('end', function(){</td></tr><tr class="hit"><td class="line">115</td><td class="hits">1</td><td class="source">        arr.complete = true;</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">    // cache hit, doesnt support range requests</td></tr><tr class="hit"><td class="line">120</td><td class="hits">10</td><td class="source">    if (hit &amp;&amp; hit.complete &amp;&amp; !ranges) {</td></tr><tr class="hit"><td class="line">121</td><td class="hits">7</td><td class="source">      header = utils.merge({}, hit[0]);</td></tr><tr class="hit"><td class="line">122</td><td class="hits">7</td><td class="source">      header.Age = age = (new Date - new Date(header.date)) / 1000 | 0;</td></tr><tr class="hit"><td class="line">123</td><td class="hits">7</td><td class="source">      header.date = new Date().toUTCString();</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">      // parse cache-controls</td></tr><tr class="hit"><td class="line">126</td><td class="hits">7</td><td class="source">      hitCC = utils.parseCacheControl(header['cache-control'] || '');</td></tr><tr class="hit"><td class="line">127</td><td class="hits">7</td><td class="source">      uaCC = utils.parseCacheControl(req.headers['cache-control'] || '');</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">      // check if we must revalidate(bypass)</td></tr><tr class="hit"><td class="line">130</td><td class="hits">8</td><td class="source">      if (hitCC['no-cache'] || uaCC['no-cache']) return miss();</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">      // check freshness of entity</td></tr><tr class="hit"><td class="line">133</td><td class="hits">6</td><td class="source">      if (isStale(hitCC, age) || isStale(uaCC, age)) return miss();</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">      // conditional GET support</td></tr><tr class="hit"><td class="line">136</td><td class="hits">6</td><td class="source">      if (utils.conditionalGET(req)) {</td></tr><tr class="miss"><td class="line">137</td><td class="hits">0</td><td class="source">        if (!utils.modified(req, res, header)) {</td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="source">          header['content-length'] = 0;</td></tr><tr class="miss"><td class="line">139</td><td class="hits">0</td><td class="source">          res.writeHead(304, header);</td></tr><tr class="miss"><td class="line">140</td><td class="hits">0</td><td class="source">          return res.end();</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">      // HEAD support</td></tr><tr class="hit"><td class="line">145</td><td class="hits">6</td><td class="source">      if ('HEAD' == req.method) {</td></tr><tr class="hit"><td class="line">146</td><td class="hits">2</td><td class="source">        res.writeHead(200, header);</td></tr><tr class="hit"><td class="line">147</td><td class="hits">2</td><td class="source">        return res.end();</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">      // respond with cache</td></tr><tr class="hit"><td class="line">151</td><td class="hits">4</td><td class="source">      header['x-cache'] = 'HIT';</td></tr><tr class="hit"><td class="line">152</td><td class="hits">4</td><td class="source">      res.writeHead(200, header);</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">      // backpressure</td></tr><tr class="hit"><td class="line">155</td><td class="hits">4</td><td class="source">      function write(i) {</td></tr><tr class="hit"><td class="line">156</td><td class="hits">8</td><td class="source">        var buf = hit[i];</td></tr><tr class="hit"><td class="line">157</td><td class="hits">12</td><td class="source">        if (!buf) return res.end();</td></tr><tr class="hit"><td class="line">158</td><td class="hits">4</td><td class="source">        if (false === res.write(buf)) {</td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="source">          res.once('drain', function(){</td></tr><tr class="miss"><td class="line">160</td><td class="hits">0</td><td class="source">            write(++i);</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">          });</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"><td class="line">163</td><td class="hits">4</td><td class="source">          write(++i);</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">167</td><td class="hits">4</td><td class="source">      return write(1);</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">170</td><td class="hits">3</td><td class="source">    miss();</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source"> * Check if cache item is stale</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source"> * @param {Object} cc</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source"> * @param {Number} age</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source"> * @return {Boolean}</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">183</td><td class="hits">1</td><td class="source">function isStale(cc, age) {</td></tr><tr class="hit"><td class="line">184</td><td class="hits">12</td><td class="source">  return cc['max-age'] &amp;&amp; cc['max-age'] &lt;= age;</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">}</td></tr></tbody></table></div><div class="file"><h2 id="cache.js">cache.js</h2><div id="stats" class="high"><div class="percentage">83%</div><div class="sloc">18</div><div class="hits">15</div><div class="misses">3</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Connect - Cache</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 Sencha Inc.</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * MIT Licensed</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * Expose `Cache`.</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">module.exports = Cache;</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> * LRU cache store.</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> * @param {Number} limit</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">21</td><td class="hits">1</td><td class="source">function Cache(limit) {</td></tr><tr class="hit"><td class="line">22</td><td class="hits">3</td><td class="source">  this.store = {};</td></tr><tr class="hit"><td class="line">23</td><td class="hits">3</td><td class="source">  this.keys = [];</td></tr><tr class="hit"><td class="line">24</td><td class="hits">3</td><td class="source">  this.limit = limit;</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> * Touch `key`, promoting the object.</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> * @param {String} key</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> * @param {Number} i</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">35</td><td class="hits">1</td><td class="source">Cache.prototype.touch = function(key, i){</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">  this.keys.splice(i,1);</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">  this.keys.push(key);</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> * Remove `key`.</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> * @param {String} key</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">47</td><td class="hits">1</td><td class="source">Cache.prototype.remove = function(key){</td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="source">  delete this.store[key];</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> * Get the object stored for `key`.</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> * @param {String} key</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> * @return {Array}</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">59</td><td class="hits">1</td><td class="source">Cache.prototype.get = function(key){</td></tr><tr class="hit"><td class="line">60</td><td class="hits">12</td><td class="source">  return this.store[key];</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source"> * Add a cache `key`.</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> * @param {String} key</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source"> * @return {Array}</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> * @api private</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">71</td><td class="hits">1</td><td class="source">Cache.prototype.add = function(key){</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">  // initialize store</td></tr><tr class="hit"><td class="line">73</td><td class="hits">1</td><td class="source">  var len = this.keys.push(key);</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">  // limit reached, invalidate LRU</td></tr><tr class="hit"><td class="line">76</td><td class="hits">1</td><td class="source">  if (len &gt; this.limit) this.remove(this.keys.shift());</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">78</td><td class="hits">1</td><td class="source">  var arr = this.store[key] = [];</td></tr><tr class="hit"><td class="line">79</td><td class="hits">1</td><td class="source">  arr.createdAt = new Date;</td></tr><tr class="hit"><td class="line">80</td><td class="hits">1</td><td class="source">  return arr;</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="middleware/cookieSession.js">middleware/cookieSession.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">23</div><div class="hits">23</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">/*!</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> * Connect - cookieSession</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> * Copyright(c) 2011 Sencha Inc.</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> * MIT Licensed</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> * Module dependencies.</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">var utils = require('./../utils')</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">  , Cookie = require('./session/cookie')</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  , debug = require('debug')('connect:cookieSession');</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">// environment</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">var env = process.env.NODE_ENV;</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">/**</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> * Cookie Session:</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> *   Cookie session middleware.</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> *      var app = connect();</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> *      app.use(connect.cookieParser('tobo!'));</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> *      app.use(connect.cookieSession({ cookie: { maxAge: 60 * 60 * 1000 }}));</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> * Options:</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> *   - `key` cookie name defaulting to `connect.sess`</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> *   - `cookie` session cookie settings, defaulting to `{ path: '/', httpOnly: true, maxAge: null }`</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> *   - `proxy` trust the reverse proxy when setting secure cookies (via &quot;x-forwarded-proto&quot;)</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> *</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> * @param {Object} options</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> * @return {Function}</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> * @api public</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> */</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">40</td><td class="hits">1</td><td class="source">module.exports = function cookieSession(options){</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">  // TODO: utilize Session/Cookie to unify API</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">  // TODO: only set-cookie on changes to the session data</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">44</td><td class="hits">14</td><td class="source">  var options = options || {}</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">    , key = options.key || 'connect.sess'</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">    , cookie = options.cookie</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">    , trustProxy = options.proxy;</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">49</td><td class="hits">14</td><td class="source">  return function cookieSession(req, res, next) {</td></tr><tr class="hit"><td class="line">50</td><td class="hits">11</td><td class="source">    req.session = req.signedCookies[key] || {};</td></tr><tr class="hit"><td class="line">51</td><td class="hits">11</td><td class="source">    req.session.cookie = new Cookie(req, cookie);</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">53</td><td class="hits">11</td><td class="source">    res.on('header', function(){</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">      // removed</td></tr><tr class="hit"><td class="line">55</td><td class="hits">11</td><td class="source">      if (!req.session) {</td></tr><tr class="hit"><td class="line">56</td><td class="hits">1</td><td class="source">        debug('clear session');</td></tr><tr class="hit"><td class="line">57</td><td class="hits">1</td><td class="source">        res.setHeader('Set-Cookie', key + '=; expires=' + new Date(0).toUTCString());</td></tr><tr class="hit"><td class="line">58</td><td class="hits">1</td><td class="source">        return;</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">61</td><td class="hits">10</td><td class="source">      var cookie = req.session.cookie;</td></tr><tr class="hit"><td class="line">62</td><td class="hits">10</td><td class="source">      delete req.session.cookie;</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">      // check security</td></tr><tr class="hit"><td class="line">65</td><td class="hits">10</td><td class="source">      var proto = (req.headers['x-forwarded-proto'] || '').toLowerCase()</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">        , tls = req.connection.encrypted || (trustProxy &amp;&amp; 'https' == proto)</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">        , secured = cookie.secure &amp;&amp; tls;</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">      // only send secure cookies via https</td></tr><tr class="hit"><td class="line">70</td><td class="hits">12</td><td class="source">      if (cookie.secure &amp;&amp; !secured) return debug('not secured');</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">      // set cookie</td></tr><tr class="hit"><td class="line">73</td><td class="hits">8</td><td class="source">      debug('serializing %j', req.session);</td></tr><tr class="hit"><td class="line">74</td><td class="hits">8</td><td class="source">      var val = 'j:' + JSON.stringify(req.session);</td></tr><tr class="hit"><td class="line">75</td><td class="hits">8</td><td class="source">      val = utils.sign(val, req.secret);</td></tr><tr class="hit"><td class="line">76</td><td class="hits">8</td><td class="source">      val = utils.serializeCookie(key, val, cookie);</td></tr><tr class="hit"><td class="line">77</td><td class="hits">8</td><td class="source">      debug('cookie %j', cookie);</td></tr><tr class="hit"><td class="line">78</td><td class="hits">8</td><td class="source">      res.setHeader('Set-Cookie', val);</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">81</td><td class="hits">11</td><td class="source">    next();</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div></div></div></body></html>